<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literature Review Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            padding-top: 20px;
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.35rem 0.65rem;
        }
        .job-row {
            cursor: pointer;
        }
        .job-row:hover {
            background-color: #f8f9fa;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #uploadProgress {
            display: none;
        }
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        /* Enhanced Outputs Section */
        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            margin-top: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .enhanced-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .enhanced-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .enhanced-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .enhanced-card .card-icon {
            font-size: 1.3em;
        }

        .enhanced-card h4 {
            margin: 0;
            font-size: 1em;
        }

        .enhanced-card .card-body {
            padding: 15px;
        }

        /* Proof Scorecard Styles */
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            border: 6px solid;
        }

        .score-circle.score-high {
            border-color: #28a745;
            color: #28a745;
        }

        .score-circle.score-medium {
            border-color: #ffc107;
            color: #ffc107;
        }

        .score-circle.score-low {
            border-color: #dc3545;
            color: #dc3545;
        }

        .score-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .score-label {
            font-size: 0.75em;
            text-transform: uppercase;
        }

        .verdict-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin: 8px 0;
            font-size: 0.85em;
        }

        .verdict-strong { background: #d4edda; color: #155724; }
        .verdict-moderate { background: #fff3cd; color: #856404; }
        .verdict-weak { background: #f8d7da; color: #721c24; }
        .verdict-insufficient { background: #f8d7da; color: #721c24; }

        .headline {
            font-style: italic;
            color: #666;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .next-steps {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .next-steps ul {
            margin: 5px 0 0 0;
            padding-left: 18px;
        }

        .next-steps li {
            margin: 4px 0;
            font-size: 0.85em;
        }

        /* Cost Summary Styles */
        .cost-metrics {
            margin: 15px 0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
            font-size: 0.9em;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1em;
        }

        .metric-value.cost-total {
            color: #667eea;
            font-size: 1.3em;
        }

        .metric-value.savings {
            color: #28a745;
        }

        .progress-bar-container {
            position: relative;
            width: 130px;
            height: 22px;
            background: #e9ecef;
            border-radius: 11px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 11px;
        }

        .progress-bar.budget-low {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }

        .progress-bar.budget-medium {
            background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
        }

        .progress-bar.budget-high {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #333;
        }

        /* Sufficiency Matrix Styles */
        .quadrant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 15px 0;
        }

        .quadrant {
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .quadrant.q1 {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
        }

        .quadrant.q2 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
        }

        .quadrant.q3 {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
        }

        .quadrant.q4 {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 2px solid #17a2b8;
        }

        .quadrant-name {
            font-weight: 600;
            font-size: 0.75em;
            margin-bottom: 6px;
        }

        .quadrant-count {
            font-size: 1.6em;
            font-weight: bold;
        }

        .recommendations {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .recommendations ul {
            margin: 5px 0 0 0;
            padding-left: 18px;
        }

        .recommendations li {
            margin: 4px 0;
            font-size: 0.85em;
        }

        /* Button Styles */
        .btn-full-report {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-full-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .enhanced-cards-grid {
                grid-template-columns: 1fr;
            }
            
            .quadrant-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Progress Monitoring Styles */
        .stage-item {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #dee2e6;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .stage-item.active {
            border-left-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .stage-item.complete {
            border-left-color: #198754;
            background: #d1e7dd;
        }
        
        .stage-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .iteration-counter {
            font-size: 0.875rem;
            color: #6c757d;
            margin-left: 8px;
        }
        
        .log-viewer-live {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-line {
            margin: 2px 0;
        }
        
        .log-line.error {
            color: #f48771;
        }
        
        .log-line.warning {
            color: #dcdcaa;
        }
        
        .log-line.success {
            color: #4ec9b0;
        }
        
        /* Summary Cards Styles */
        .job-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: box-shadow 0.2s;
        }
        
        .job-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .job-header h5 {
            margin: 0;
            font-size: 1rem;
        }
        
        .job-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .job-summary-cards {
            display: flex;
            gap: 12px;
            margin: 12px 0;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .summary-card {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            background-color: white;
            border: 1px solid #dee2e6;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .summary-card .metric-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .summary-card .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .summary-card .metric-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }

        /* Color-coded completeness */
        .summary-card.completeness.bg-success {
            background-color: #d4edda !important;
            border-color: #28a745;
        }

        .summary-card.completeness.bg-warning {
            background-color: #fff3cd !important;
            border-color: #ffc107;
        }

        .summary-card.completeness.bg-danger {
            background-color: #f8d7da !important;
            border-color: #dc3545;
        }

        /* Critical gaps alert */
        .summary-card.critical-gaps.has-alerts {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .summary-card.critical-gaps.has-alerts .metric-value {
            color: #dc3545;
        }

        /* Recommendations preview */
        .metric-preview {
            display: none;
            margin-top: 8px;
            text-align: left;
            font-size: 11px;
            max-height: 80px;
            overflow-y: auto;
        }

        .summary-card:hover .metric-preview {
            display: block;
        }

        .metric-preview ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .metric-preview li {
            padding: 2px 0;
            color: #495057;
        }

        .summary-card.no-results {
            flex: 1 1 100%;
            font-style: italic;
            color: #6c757d;
        }
        
        /* Pre-filter Configuration Styles (PARITY-W2-5) */
        .section-checkbox:checked ~ label {
            font-weight: 600;
            color: #0d6efd;
        }

        #selectedSectionsPreview {
            font-family: monospace;
            color: #0d6efd;
        }

        /* Resume Controls - Stage Progress Diagram */
        .stage-box {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            min-width: 70px;
            background: white;
            transition: all 0.3s;
        }

        .stage-box.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        .stage-box.active {
            background: #fff3cd;
            border-color: #ffc107;
            font-weight: bold;
        }

        .stage-box.pending {
            background: #f8f9fa;
            border-color: #ccc;
            opacity: 0.6;
        }

        .stage-arrow {
            margin: 0 5px;
            font-size: 16px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status">
        <span class="badge bg-secondary" id="wsStatus">Connecting...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-4">üìö Literature Review Dashboard</h1>
                <p class="lead">
                    Monitor and manage pipeline jobs
                    <button class="btn btn-sm btn-outline-info ms-3" onclick="openResultsBrowser()">
                        üîç Browse All Results
                    </button>
                </p>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Total Jobs</h5>
                        <h2 class="display-4" id="totalJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">Completed</h5>
                        <h2 class="display-4" id="completedJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Running</h5>
                        <h2 class="display-4" id="runningJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-danger">Failed</h5>
                        <h2 class="display-4" id="failedJobs">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resource Monitoring Section -->
        <div class="row mb-4" id="resourceMonitorContainer">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä System Resources</h5>
                        <span id="monitorConnectionStatus" class="badge bg-secondary">Connecting...</span>
                    </div>
                    <div class="card-body">
                        <!-- Alerts Container -->
                        <div id="resourceAlerts"></div>
                        
                        <!-- Current Usage -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">CPU Usage</h6>
                                        <h3 id="cpuPercent">0%</h3>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div id="cpuBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="cpuCores">0 cores</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Memory Usage</h6>
                                        <h3 id="memoryPercent">0%</h3>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div id="memoryBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="memoryUsed">0 / 0 GB</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Disk Usage</h6>
                                        <h3 id="diskPercent">0%</h3>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div id="diskBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="diskUsed">0 / 0 GB</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">CPU Usage (Last 5 Minutes)</h6>
                                <div style="height: 200px;">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Memory Usage (Last 5 Minutes)</h6>
                                <div style="height: 200px;">
                                    <canvas id="memoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì§ Upload Research Papers</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="openNewAnalysisModal()">
                            üöÄ New Analysis (No Upload)
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Analysis Mode Selector -->
                        <div class="mode-selector card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Analysis Mode</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="analysisMode" 
                                           id="modeBaseline" value="baseline" checked>
                                    <label class="form-check-label" for="modeBaseline">
                                        <strong>New Review</strong> (baseline)
                                        <small class="text-muted d-block">
                                            Analyze all papers from scratch
                                        </small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="analysisMode" 
                                           id="modeContinuation" value="continuation">
                                    <label class="form-check-label" for="modeContinuation">
                                        <strong>Continue Existing Review</strong> (incremental)
                                        <small class="text-muted d-block">
                                            Add new papers to previous analysis
                                        </small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Base Job Selector (shown when continuation mode selected) -->
                        <div id="baseJobSelector" class="card mb-4" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">Select Base Job</h5>
                                
                                <div class="mb-3">
                                    <label for="baseJobDropdown" class="form-label">
                                        Choose a completed review to continue:
                                    </label>
                                    <select class="form-select" id="baseJobDropdown">
                                        <option value="">-- Select a job --</option>
                                        <!-- Populated dynamically via JS -->
                                    </select>
                                </div>
                                
                                <div id="gapSummaryPanel" style="display: none;">
                                    <!-- Gap summary loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Options Panel -->
                        <div class="card mb-4">
                            <div class="card-header" style="cursor: pointer;" 
                                 data-bs-toggle="collapse" data-bs-target="#advancedOptionsPanel">
                                <h5 class="mb-0">
                                    ‚öôÔ∏è Advanced Options
                                    <span class="badge bg-secondary float-end">Optional</span>
                                    <i class="bi bi-chevron-down float-end me-2"></i>
                                </h5>
                            </div>
                            <div id="advancedOptionsPanel" class="collapse">
                                <div class="card-body">
                                    
                                    <!-- Dry Run Mode -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="dryRunMode">
                                            <label class="form-check-label" for="dryRunMode">
                                                <strong>Dry Run</strong>
                                                <span class="badge bg-info ms-2">CLI: --dry-run</span>
                                            </label>
                                            <div class="form-text">
                                                Validate configuration without making API calls or spending credits.
                                                Shows what would run.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Force Re-analysis -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="forceReanalysis"
                                                   onchange="updateForceWarning()">
                                            <label class="form-check-label" for="forceReanalysis">
                                                <strong>Force Re-analysis</strong>
                                                <span class="badge bg-warning text-dark ms-2">CLI: --force</span>
                                            </label>
                                            <div class="form-text">
                                                Re-run analysis even if recent results exist. Ignores all cached responses.
                                            </div>
                                        </div>
                                        
                                        <!-- Cost Warning (shown when force enabled) -->
                                        <div id="forceWarning" style="display: none;" class="alert alert-warning mt-2">
                                            <strong>‚ö†Ô∏è Cost Impact</strong>
                                            <p class="mb-2">
                                                Forcing re-analysis will make fresh API calls instead of using cached responses.
                                                This may significantly increase costs.
                                            </p>
                                            
                                            <!-- Cost Estimation -->
                                            <div id="costEstimate" class="mt-2">
                                                <small>
                                                    <strong>Estimated Impact:</strong><br>
                                                    Cached run: ~$<span id="cachedCost">0.50</span><br>
                                                    Fresh run: ~$<span id="freshCost">5.00</span><br>
                                                    <strong>Difference: +$<span id="costDiff">4.50</span></strong>
                                                </small>
                                            </div>
                                            
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="forceConfirm">
                                                <label class="form-check-label" for="forceConfirm">
                                                    <small>I understand this will increase costs</small>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Use Cases Help -->
                                        <div class="collapse mt-2" id="forceUseCases">
                                            <div class="card card-body bg-light">
                                                <h6>When to Use Force Re-analysis:</h6>
                                                <ul class="mb-0 small">
                                                    <li>Testing new models or prompts</li>
                                                    <li>Verifying configuration changes</li>
                                                    <li>Ensuring reproducibility (fresh run)</li>
                                                    <li>Cache corruption suspected</li>
                                                    <li>Model API behavior changed</li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-sm btn-link p-0 mt-1"
                                                data-bs-toggle="collapse" data-bs-target="#forceUseCases">
                                            ‚ÑπÔ∏è When should I use this?
                                        </button>
                                    </div>
                                    
                                    <!-- Clear Cache -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="clearCache">
                                            <label class="form-check-label" for="clearCache">
                                                <strong>Clear Cache</strong>
                                                <span class="badge bg-danger ms-2">CLI: --clear-cache</span>
                                            </label>
                                            <div class="form-text">
                                                Delete all cached API responses before starting. 
                                                Use when switching models or updating prompts.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <!-- Budget Control -->
                                    <div class="mb-3">
                                        <label for="budgetLimit" class="form-label">
                                            <strong>Budget Limit (USD)</strong>
                                            <span class="badge bg-primary ms-2">CLI: --budget</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" 
                                                   id="budgetLimit" 
                                                   placeholder="5.00" 
                                                   step="0.01" 
                                                   min="0">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="document.getElementById('budgetLimit').value = ''">
                                                Clear
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            Maximum spending for this job. Pipeline stops when reached.
                                            Leave empty for unlimited.
                                        </div>
                                    </div>
                                    
                                    <!-- Relevance Threshold -->
                                    <div class="mb-3">
                                        <label for="relevanceThreshold" class="form-label">
                                            <strong>Relevance Threshold</strong>
                                            <span class="badge bg-success ms-2">CLI: --relevance-threshold</span>
                                        </label>
                                        <div class="row align-items-center">
                                            <div class="col-8">
                                                <input type="range" class="form-range" 
                                                       id="relevanceThreshold" 
                                                       min="0.5" max="1.0" step="0.05" 
                                                       value="0.7"
                                                       oninput="updateThresholdDisplay(this.value)">
                                            </div>
                                            <div class="col-4">
                                                <input type="number" class="form-control form-control-sm" 
                                                       id="relevanceThresholdValue" 
                                                       value="0.7" 
                                                       min="0.5" max="1.0" step="0.05"
                                                       oninput="document.getElementById('relevanceThreshold').value = this.value; updateThresholdDisplay(this.value)">
                                            </div>
                                        </div>
                                        <div class="form-text">
                                            Minimum semantic similarity for papers to be considered relevant.
                                            Higher = stricter filtering (0.5-1.0).
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <!-- Resume Controls Card -->
                                    <div class="card mb-3 border-info">
                                        <div class="card-header bg-info bg-opacity-10">
                                            <h6 class="mb-0">‚ôªÔ∏è Resume Controls</h6>
                                        </div>
                                        <div class="card-body">
                                            
                                            <!-- Resume from Stage -->
                                            <div class="mb-3">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="enableResumeStage"
                                                           onchange="toggleResumeStage()">
                                                    <label class="form-check-label" for="enableResumeStage">
                                                        <strong>Resume from Stage</strong>
                                                        <span class="badge bg-info">CLI: --resume-from</span>
                                                    </label>
                                                </div>
                                                
                                                <!-- Stage Selector -->
                                                <select class="form-select" id="resumeStage" disabled onchange="updateStageHighlight()">
                                                    <option value="">-- Select Stage to Resume From --</option>
                                                    <option value="journal_reviewer">Journal Reviewer (Stage 1)</option>
                                                    <option value="judge">Judge (Stage 2)</option>
                                                    <option value="dra">DRA Appeal (Stage 3)</option>
                                                    <option value="sync">Sync to Database (Stage 4)</option>
                                                    <option value="orchestrator">Gap Analysis (Stage 5)</option>
                                                    <option value="proof_scorecard">Proof Scorecard (Stage 6)</option>
                                                    <option value="sufficiency_matrix">Sufficiency Matrix (Stage 7)</option>
                                                </select>
                                                
                                                <div class="form-text">
                                                    Skip completed stages and start from selected stage.
                                                    Requires previous results in output directory.
                                                </div>
                                                
                                                <!-- Stage Progress Diagram -->
                                                <div class="mt-3" id="stageProgressDiagram" style="display: none;">
                                                    <small class="text-muted">Pipeline Stages:</small>
                                                    <div class="d-flex align-items-center mt-2 flex-wrap" style="gap: 5px;">
                                                        <div class="stage-box" id="stage-journal">
                                                            <small>Journal<br>Review</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-judge">
                                                            <small>Judge</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-dra">
                                                            <small>DRA</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-sync">
                                                            <small>Sync</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-orch">
                                                            <small>Gap<br>Analysis</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-proof">
                                                            <small>Proof</small>
                                                        </div>
                                                        <div class="stage-arrow">‚Üí</div>
                                                        <div class="stage-box" id="stage-suff">
                                                            <small>Sufficiency</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <hr>
                                            
                                            <!-- Resume from Checkpoint -->
                                            <div class="mb-3">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="enableResumeCheckpoint"
                                                           onchange="toggleResumeCheckpoint()">
                                                    <label class="form-check-label" for="enableResumeCheckpoint">
                                                        <strong>Resume from Checkpoint</strong>
                                                        <span class="badge bg-info">CLI: --resume --checkpoint-file</span>
                                                    </label>
                                                </div>
                                                
                                                <!-- Checkpoint File Input -->
                                                <div id="checkpointInputSection" style="display: none;">
                                                    <div class="input-group mb-2">
                                                        <input type="text" class="form-control" 
                                                               id="checkpointFilePath" 
                                                               placeholder="pipeline_checkpoint.json" readonly>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                onclick="scanForCheckpoints()"
                                                                aria-label="Auto-detect checkpoint files in output directory">
                                                            üîç Auto-detect
                                                        </button>
                                                        <button class="btn btn-outline-primary" type="button"
                                                                onclick="document.getElementById('checkpointFileUpload').click()"
                                                                aria-label="Upload checkpoint file from your computer">
                                                            üì§ Upload
                                                        </button>
                                                    </div>
                                                    <input type="file" id="checkpointFileUpload" 
                                                           accept=".json" style="display: none;"
                                                           onchange="handleCheckpointUpload(this)">
                                                    
                                                    <div class="form-text">
                                                        Continue from saved checkpoint. Auto-detect scans output directory.
                                                    </div>
                                                    
                                                    <!-- Detected Checkpoints -->
                                                    <div id="detectedCheckpoints" style="display: none;" class="mt-2">
                                                        <small><strong>Detected Checkpoints:</strong></small>
                                                        <div class="list-group list-group-flush" id="checkpointList">
                                                            <!-- Populated dynamically -->
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Checkpoint Preview -->
                                                    <div id="checkpointPreview" style="display: none;" class="mt-3">
                                                        <div class="card bg-light">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Checkpoint Details</h6>
                                                                <dl class="row mb-0 small">
                                                                    <dt class="col-sm-4">Modified:</dt>
                                                                    <dd class="col-sm-8" id="checkpointCreated">-</dd>
                                                                    
                                                                    <dt class="col-sm-4">Last Stage:</dt>
                                                                    <dd class="col-sm-8" id="checkpointLastStage">-</dd>
                                                                    
                                                                    <dt class="col-sm-4">Papers:</dt>
                                                                    <dd class="col-sm-8" id="checkpointPapersProcessed">-</dd>
                                                                    
                                                                    <dt class="col-sm-4">Will Resume From:</dt>
                                                                    <dd class="col-sm-8" id="checkpointResumeFrom">-</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Mutual Exclusion Warning -->
                                            <div id="resumeConflictWarning" style="display: none;" class="alert alert-warning">
                                                ‚ö†Ô∏è Only one resume method can be used at a time. 
                                                Using checkpoint will override stage selection.
                                            </div>
                                            
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <!-- Experimental Features -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="experimentalFeatures">
                                            <label class="form-check-label" for="experimentalFeatures">
                                                <strong>Enable Experimental Features</strong>
                                                <span class="badge bg-warning text-dark ms-2">CLI: --enable-experimental</span>
                                            </label>
                                            <div class="form-text">
                                                ‚ö†Ô∏è Use cutting-edge features (may be unstable). 
                                                Includes: advanced caching, parallel scoring, new prompts.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Config File Upload -->
                                    <div class="mb-3">
                                        <label for="configFileUpload" class="form-label">
                                            <strong>Custom Configuration File</strong>
                                            <span class="badge bg-secondary ms-2">CLI: --config</span>
                                        </label>
                                        
                                        <input class="form-control" type="file" 
                                               id="configFileUpload" 
                                               accept=".json"
                                               onchange="handleConfigUpload(this)">
                                        
                                        <div class="form-text">
                                            Upload custom pipeline_config.json to override defaults.
                                            <a href="#" onclick="downloadConfigTemplate(); return false;">Download template</a>
                                        </div>
                                        
                                        <!-- Config Preview -->
                                        <div id="configPreview" style="display: none;" class="mt-3">
                                            <div class="card">
                                                <div class="card-header bg-light">
                                                    <h6 class="mb-0">
                                                        üìÑ Configuration Preview
                                                        <button type="button" class="btn btn-sm btn-outline-danger float-end"
                                                                onclick="clearConfigUpload()">
                                                            ‚úï Remove
                                                        </button>
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Validation Status -->
                                                    <div id="configValidation" class="alert" role="alert">
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">Validating...</span>
                                                        </div>
                                                        Validating configuration...
                                                    </div>
                                                    
                                                    <!-- Config Details -->
                                                    <div id="configDetails" style="display: none;">
                                                        <dl class="row mb-0">
                                                            <dt class="col-sm-4">Version:</dt>
                                                            <dd class="col-sm-8" id="configVersion">-</dd>
                                                            
                                                            <dt class="col-sm-4">Overrides:</dt>
                                                            <dd class="col-sm-8" id="configOverrides">-</dd>
                                                        </dl>
                                                        
                                                        <!-- View Full Config -->
                                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                                                                data-bs-toggle="collapse" data-bs-target="#fullConfigView">
                                                            üëÅÔ∏è View Full Configuration
                                                        </button>
                                                        
                                                        <div id="fullConfigView" class="collapse mt-2">
                                                            <pre id="fullConfigJSON" class="bg-light p-3 rounded" 
                                                                 style="max-height: 300px; overflow-y: auto; font-size: 0.85em;"></pre>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Validation Errors -->
                                                    <div id="configErrors" style="display: none;" class="alert alert-danger mt-3">
                                                        <strong>‚ö†Ô∏è Validation Errors:</strong>
                                                        <ul id="configErrorList" class="mb-0 mt-2"></ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <!-- Pre-Filter Configuration (PARITY-W2-5) -->
                                    <div class="card mb-3 border-secondary">
                                        <div class="card-header bg-secondary bg-opacity-10">
                                            <h6 class="mb-0">üìÑ Pre-Filter: Paper Sections</h6>
                                        </div>
                                        <div class="card-body">
                                            
                                            <!-- Mode Selector -->
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <strong>Analysis Scope</strong>
                                                    <span class="badge bg-secondary">CLI: --pre-filter</span>
                                                </label>
                                                
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="prefilterMode" 
                                                           id="prefilterDefault" value="default" checked
                                                           onchange="updatePreFilterMode()">
                                                    <label class="btn btn-outline-secondary" for="prefilterDefault">
                                                        ‚úÖ Default<br>
                                                        <small class="text-muted">Title + Abstract + Intro</small>
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="prefilterMode" 
                                                           id="prefilterCustom" value="custom"
                                                           onchange="updatePreFilterMode()">
                                                    <label class="btn btn-outline-primary" for="prefilterCustom">
                                                        üéõÔ∏è Custom<br>
                                                        <small class="text-muted">Choose Sections</small>
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="prefilterMode" 
                                                           id="prefilterFull" value="full"
                                                           onchange="updatePreFilterMode()">
                                                    <label class="btn btn-outline-warning" for="prefilterFull">
                                                        üìñ Full Paper<br>
                                                        <small class="text-muted">All Sections</small>
                                                    </label>
                                                </div>
                                                
                                                <div class="form-text">
                                                    Control which sections to analyze for gap extraction. 
                                                    Fewer sections = faster analysis and lower cost.
                                                </div>
                                            </div>
                                            
                                            <!-- Custom Section Selector -->
                                            <div id="customSectionsPanel" style="display: none;" class="mb-3">
                                                <label class="form-label">Select Sections to Analyze:</label>
                                                
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_title" value="title" checked>
                                                            <label class="form-check-label" for="section_title">
                                                                <strong>Title</strong>
                                                                <small class="text-muted d-block">Paper title and keywords</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_abstract" value="abstract" checked>
                                                            <label class="form-check-label" for="section_abstract">
                                                                <strong>Abstract</strong>
                                                                <small class="text-muted d-block">High-level summary</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_introduction" value="introduction" checked>
                                                            <label class="form-check-label" for="section_introduction">
                                                                <strong>Introduction</strong>
                                                                <small class="text-muted d-block">Background and motivation</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_methods" value="methods">
                                                            <label class="form-check-label" for="section_methods">
                                                                <strong>Methods</strong>
                                                                <small class="text-muted d-block">Experimental design</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_results" value="results">
                                                            <label class="form-check-label" for="section_results">
                                                                <strong>Results</strong>
                                                                <small class="text-muted d-block">Findings and data</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_discussion" value="discussion">
                                                            <label class="form-check-label" for="section_discussion">
                                                                <strong>Discussion</strong>
                                                                <small class="text-muted d-block">Interpretation and implications</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_conclusion" value="conclusion">
                                                            <label class="form-check-label" for="section_conclusion">
                                                                <strong>Conclusion</strong>
                                                                <small class="text-muted d-block">Summary and future work</small>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input section-checkbox" type="checkbox" 
                                                                   id="section_references" value="references">
                                                            <label class="form-check-label" for="section_references">
                                                                <strong>References</strong>
                                                                <small class="text-muted d-block">Bibliography and citations</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Selection Summary -->
                                                <div class="mt-3 p-2 bg-light rounded">
                                                    <small>
                                                        <strong>Selected sections:</strong> 
                                                        <span id="selectedSectionsPreview">title, abstract, introduction</span>
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- Impact Preview -->
                                            <div class="alert alert-info mb-3">
                                                <div class="row">
                                                    <div class="col-md-4 text-center">
                                                        <div class="small text-muted">Estimated Sections</div>
                                                        <div class="fs-5 fw-bold" id="prefilterSectionCount">3</div>
                                                    </div>
                                                    <div class="col-md-4 text-center">
                                                        <div class="small text-muted">Relative Speed</div>
                                                        <div class="fs-5 fw-bold" id="prefilterSpeed">Fast ‚ö°</div>
                                                    </div>
                                                    <div class="col-md-4 text-center">
                                                        <div class="small text-muted">Relative Cost</div>
                                                        <div class="fs-5 fw-bold" id="prefilterCost">Low üí∞üí∞</div>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="small">
                                                    <strong>üí° Recommendation:</strong> <span id="prefilterRecommendation">
                                                        Default configuration balances coverage and efficiency for most reviews.
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Common Presets -->
                                            <div class="mt-3">
                                                <label class="form-label"><small><strong>Quick Presets:</strong></small></label>
                                                <div class="btn-group btn-group-sm w-100">
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="applyPreset('default')">
                                                        Default
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="applyPreset('abstract-only')">
                                                        Abstract Only
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="applyPreset('methods-focus')">
                                                        Methods Focus
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="applyPreset('comprehensive')">
                                                        Comprehensive
                                                    </button>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                    
                                    <!-- Reset to Defaults -->
                                    <div class="text-end">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="resetAdvancedOptions()">
                                            üîÑ Reset to Defaults
                                        </button>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        
                        <form id="batchUploadForm">
                            <!-- Input Method Selection (PARITY-W3-2) -->
                            <div class="card mb-3 border-primary">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h6 class="mb-0">üì• Input Method</h6>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group w-100 mb-3" role="group" aria-label="Input method selection">
                                        <input type="radio" class="btn-check" name="inputMethod" id="inputMethodUpload" value="upload" checked>
                                        <label class="btn btn-outline-primary" for="inputMethodUpload">
                                            üì§ Upload Files
                                            <small class="d-block text-muted">From your computer</small>
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="inputMethod" id="inputMethodDirectory" value="directory">
                                        <label class="btn btn-outline-primary" for="inputMethodDirectory">
                                            üìÅ Directory Path
                                            <small class="d-block text-muted">Server directory</small>
                                        </label>
                                    </div>
                                    
                                    <!-- Upload Section (shown when Upload Files selected) -->
                                    <div id="uploadMethodSection">
                                        <div class="mb-3">
                                            <label class="form-label">Upload Mode</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="uploadMode" id="uploadModeFiles" value="files" checked>
                                                <label class="form-check-label" for="uploadModeFiles">
                                                    üìÑ Select Individual Files
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="uploadMode" id="uploadModeFolder" value="folder">
                                                <label class="form-check-label" for="uploadModeFolder">
                                                    üìÅ Select Folder (Recursive - like CLI)
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- File Selection (default) -->
                                        <div class="mb-3" id="fileUploadSection">
                                            <label for="batchFileInput" class="form-label">
                                                Select PDF files (multiple allowed)
                                            </label>
                                            <input 
                                                class="form-control" 
                                                type="file" 
                                                id="batchFileInput" 
                                                accept=".pdf" 
                                                multiple
                                                required>
                                            <div class="form-text">
                                                Select one or more research papers (PDF format only)
                                            </div>
                                        </div>
                                        
                                        <!-- Folder Selection (hidden by default) -->
                                        <div class="mb-3" id="folderUploadSection" style="display: none;">
                                            <label for="folderInput" class="form-label">
                                                Select Folder (all PDFs will be extracted recursively)
                                            </label>
                                            <input 
                                                class="form-control" 
                                                type="file" 
                                                id="folderInput" 
                                                webkitdirectory
                                                directory
                                                multiple>
                                            <div class="form-text">
                                                Choose a folder containing PDF files (nested folders supported)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Directory Path Section (shown when Directory Path selected) -->
                                    <div id="directoryMethodSection" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>üìÅ Server Directory Input</strong>
                                            <p class="mb-0 small">
                                                Point to papers already on the server. No upload needed!
                                                <br>
                                                <span class="badge bg-secondary">CLI: --data-dir</span>
                                            </p>
                                        </div>
                                        
                                        <!-- Directory Path Input -->
                                        <div class="mb-3">
                                            <label for="directoryPathInput" class="form-label">
                                                Server Directory Path
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">üìÇ</span>
                                                <input 
                                                    type="text" 
                                                    class="form-control" 
                                                    id="directoryPathInput" 
                                                    placeholder="/workspaces/Literature-Review/data/papers/"
                                                    aria-label="Server directory path">
                                                <button 
                                                    class="btn btn-outline-primary" 
                                                    type="button" 
                                                    id="scanDirectoryBtn"
                                                    onclick="scanDirectory()">
                                                    üîç Scan
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Enter absolute path to directory containing PDFs/CSVs on the server.
                                            </div>
                                        </div>
                                        
                                        <!-- Scan Options -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="scanRecursive" checked>
                                                    <label class="form-check-label" for="scanRecursive">
                                                        <strong>Recursive Scan</strong>
                                                        <small class="text-muted d-block">Include subdirectories</small>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="followSymlinks">
                                                    <label class="form-check-label" for="followSymlinks">
                                                        <strong>Follow Symlinks</strong>
                                                        <small class="text-muted d-block">Include linked directories</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Scan Results (hidden until scan complete) -->
                                        <div id="directoryScanResults" style="display: none;">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title text-success">
                                                        ‚úÖ Directory Scanned Successfully
                                                    </h6>
                                                    
                                                    <!-- File Counts -->
                                                    <div class="row text-center mb-3">
                                                        <div class="col-4">
                                                            <div class="h4 mb-0" id="scanPdfCount">0</div>
                                                            <small class="text-muted">PDFs</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h4 mb-0" id="scanCsvCount">0</div>
                                                            <small class="text-muted">CSVs</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h4 mb-0" id="scanTotalSize">0 KB</div>
                                                            <small class="text-muted">Total Size</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Subdirectory Count -->
                                                    <div class="small text-muted mb-2">
                                                        <span id="scanSubdirCount">0</span> subdirectories scanned
                                                    </div>
                                                    
                                                    <!-- View Files Button -->
                                                    <button 
                                                        type="button" 
                                                        class="btn btn-sm btn-outline-secondary"
                                                        onclick="showFileListModal()">
                                                        üìã View File List
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Scan Error (hidden until error) -->
                                        <div id="directoryScanError" style="display: none;">
                                            <div class="alert alert-danger">
                                                <strong>‚ùå Scan Failed</strong>
                                                <p class="mb-0" id="scanErrorMessage"></p>
                                            </div>
                                        </div>
                                        
                                        <!-- Security Warning -->
                                        <div class="alert alert-secondary small mt-3">
                                            <strong>üîí Security:</strong>
                                            Only directories within allowed server locations can be accessed.
                                            Path traversal attempts will be rejected.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Output Directory Configuration -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6>üìÅ Output Directory</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Mode Selector -->
                                    <div class="mb-3">
                                        <label class="form-label">Save Results To:</label>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="outputDirMode" id="outputDirAuto" 
                                                   value="auto" checked>
                                            <label class="form-check-label" for="outputDirAuto">
                                                <strong>Auto-generated</strong>
                                                <small class="text-muted d-block">
                                                    Default: workspace/jobs/{job_id}/outputs/gap_analysis_output/
                                                </small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="outputDirMode" id="outputDirCustom" 
                                                   value="custom">
                                            <label class="form-check-label" for="outputDirCustom">
                                                <strong>Custom Path</strong>
                                                <small class="text-muted d-block">
                                                    Specify where to save results (like CLI --output-dir)
                                                </small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="outputDirMode" id="outputDirExisting" 
                                                   value="existing">
                                            <label class="form-check-label" for="outputDirExisting">
                                                <strong>Select Existing Directory</strong>
                                                <small class="text-muted d-block">
                                                    Continue analysis in existing folder
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Custom Path Input (shown when "Custom Path" selected) -->
                                    <div id="customPathSection" style="display: none;">
                                        <label for="customOutputPath" class="form-label">Output Directory Path:</label>
                                        <input type="text" class="form-control" id="customOutputPath" 
                                               placeholder="/path/to/output or ./relative/path">
                                        <div class="form-text">
                                            Enter absolute path (e.g., /project/review_v1) or relative (e.g., ./my_review)
                                        </div>
                                        
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="overwriteExisting">
                                            <label class="form-check-label" for="overwriteExisting">
                                                Overwrite existing results (like CLI --force)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Existing Directory Selector (shown when "Select Existing" selected) -->
                                    <div id="existingDirSection" style="display: none;">
                                        <label for="existingDirDropdown" class="form-label">Choose Directory:</label>
                                        <select class="form-select" id="existingDirDropdown">
                                            <option value="">-- Select a directory --</option>
                                            <!-- Populated dynamically -->
                                        </select>
                                        <button type="button" class="btn btn-sm btn-secondary mt-2" 
                                                onclick="refreshOutputDirectoryList()">
                                            üîÑ Refresh List
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Directory State Indicator (shown after directory selection) -->
                            <div id="directoryStateIndicator" class="alert mt-3" style="display: none;">
                                <h6 class="alert-heading">
                                    <span id="stateIcon"></span>
                                    Directory Analysis
                                </h6>
                                <p id="stateDescription"></p>
                                
                                <div id="recommendationBox" class="mt-3">
                                    <strong>Recommended Mode:</strong>
                                    <span id="recommendedMode" class="badge"></span>
                                    <p id="recommendationReason" class="mb-0 mt-2"></p>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="btn-group mt-3" role="group">
                                    <button type="button" class="btn btn-sm btn-primary" id="acceptRecommendation">
                                        ‚úÖ Use Recommended Mode
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="changeMode">
                                        üîÄ Choose Different Mode
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="apiKeyInput" class="form-label">API Key</label>
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="apiKeyInput" 
                                    value="dev-key-change-in-production">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                üì§ Upload Papers
                            </button>
                        </form>
                        
                        <!-- Relevance Preview (shown in continuation mode after upload) -->
                        <div id="relevancePreview" class="card mb-4 mt-4" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">Relevance Preview</h5>
                                
                                <div class="mb-3">
                                    <label for="relevanceThreshold" class="form-label">
                                        Relevance Threshold: <strong id="thresholdValue">50%</strong>
                                    </label>
                                    <input type="range" class="form-range" id="relevanceThreshold" 
                                           min="0" max="100" value="50">
                                </div>
                                
                                <div class="alert alert-secondary">
                                    <strong id="papersToAnalyze">--</strong> papers will be analyzed
                                    (<strong id="papersSkipped">--</strong> filtered out)
                                </div>
                                
                                <div class="paper-list" id="paperRelevanceList">
                                    <!-- Populated with uploaded papers + scores -->
                                </div>
                                
                                <div class="estimates mt-3">
                                    <small class="text-muted">
                                        Estimated cost: <strong id="estimatedCost">--</strong><br>
                                        Estimated time: <strong id="estimatedTime">--</strong>
                                    </small>
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success" onclick="if(window.continuationMode) window.continuationMode.startAnalysis()">
                                        üöÄ Start Incremental Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress mt-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Uploading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Existing Results Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üìÇ Import Existing Results</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Load and visualize results from previous CLI runs or external analyses
                        </p>
                        <form id="importResultsForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="importDirSelect" class="form-label">
                                            Select Results Directory
                                        </label>
                                        <select 
                                            class="form-select" 
                                            id="importDirSelect"
                                            required>
                                            <option value="">Loading available directories...</option>
                                        </select>
                                        <div class="form-text">
                                            Select a directory containing gap analysis outputs
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="importNameInput" class="form-label">
                                            Job Name (Optional)
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="importNameInput" 
                                            placeholder="e.g., 2024-11-15 Neuromorphic Study">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                üì• Import Results
                            </button>
                        </form>
                        
                        <div id="importStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <span id="importMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìã Jobs</h5>
                    </div>
                    <div class="card-body">
                        <!-- Bulk Operations Controls -->
                        <div class="mb-3">
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllJobs">
                                    Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllJobs">
                                    Deselect All
                                </button>
                                <span class="ms-3 text-muted" id="selectedCount">0 jobs selected</span>
                            </div>
                        </div>
                        
                        <!-- Bulk Actions (shown when jobs selected) -->
                        <div id="bulkActionsContainer" style="display: none;" class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                                <strong>Bulk Actions:</strong>
                                <button type="button" class="btn btn-sm btn-success bulk-action-btn" id="bulkStart" disabled onclick="startSelectedJobs()">
                                    ‚ñ∂Ô∏è Start Selected
                                </button>
                                <button type="button" class="btn btn-sm btn-danger bulk-action-btn" id="bulkDelete" disabled onclick="deleteSelectedJobs()">
                                    üóëÔ∏è Delete Selected
                                </button>
                                <button type="button" class="btn btn-sm btn-primary bulk-action-btn" id="bulkExport" disabled>
                                    üì¶ Export as ZIP
                                </button>
                                <button type="button" class="btn btn-sm btn-info bulk-action-btn" id="bulkCompare" disabled>
                                    üìä Compare Jobs
                                </button>
                            </div>
                        </div>
                        
                        <div id="jobsContainer">
                            <div class="text-center text-muted p-4">
                                No jobs yet. Upload a PDF to get started.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <!-- Job Info -->
                        <div class="alert alert-info">
                            <strong>Job ID:</strong> <span id="configJobId"></span><br>
                            <strong>Files:</strong> <span id="configFileCount"></span> PDFs uploaded
                        </div>
                        
                        <!-- Pillar Selection -->
                        <div class="mb-4">
                            <h6>Select Pillars to Analyze</h6>
                            <div class="form-check">
                                <input 
                                    class="form-check-input pillar-checkbox" 
                                    type="checkbox" 
                                    value="ALL" 
                                    id="pillar_all"
                                    onchange="toggleAllPillars(this)">
                                <label class="form-check-label" for="pillar_all">
                                    <strong>All Pillars</strong> (Comprehensive Analysis)
                                </label>
                            </div>
                            <hr>
                            <div id="pillarCheckboxes">
                                <!-- Populated dynamically from pillar_definitions.json -->
                            </div>
                        </div>
                        
                        <!-- Run Mode Selection -->
                        <div class="mb-4">
                            <h6>Analysis Mode</h6>
                            <div class="form-check">
                                <input 
                                    class="form-check-input" 
                                    type="radio" 
                                    name="runMode" 
                                    value="ONCE" 
                                    id="mode_once"
                                    checked>
                                <label class="form-check-label" for="mode_once">
                                    <strong>Single Pass</strong> - Quick analysis (faster)
                                </label>
                                <div class="form-text ms-4">
                                    Runs analysis once without iterative refinement.
                                    Recommended for initial exploration.
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input 
                                    class="form-check-input" 
                                    type="radio" 
                                    name="runMode" 
                                    value="DEEP_LOOP" 
                                    id="mode_deep">
                                <label class="form-check-label" for="mode_deep">
                                    <strong>Deep Iterative Loop</strong> - Comprehensive (slower)
                                </label>
                                <div class="form-text ms-4">
                                    Runs Deep Reviewer iteratively until convergence (¬±5%).
                                    Provides most thorough gap analysis.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Options (Optional) -->
                        <div class="mb-3">
                            <button 
                                class="btn btn-sm btn-outline-secondary" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#advancedOptions">
                                ‚öôÔ∏è Advanced Options
                            </button>
                            <div class="collapse mt-2" id="advancedOptions">
                                <div class="card card-body">
                                    <div class="mb-2">
                                        <label class="form-label">Convergence Threshold (%)</label>
                                        <input 
                                            type="number" 
                                            class="form-control" 
                                            id="convergenceThreshold"
                                            value="5.0"
                                            min="0.1"
                                            max="20"
                                            step="0.1">
                                        <div class="form-text">
                                            Stop iterating when changes are below this threshold
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveConfigAndStart()">
                        üöÄ Save & Start Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal fade" id="jobDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Job ID:</strong>
                            <p id="detailJobId" class="font-monospace"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            <p id="detailStatus"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Filename:</strong>
                            <p id="detailFilename"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong>
                            <p id="detailCreated"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="errorSection" style="display: none;">
                        <strong>Error:</strong>
                        <div class="alert alert-danger" id="detailError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Logs:</strong>
                        <div class="log-viewer" id="detailLogs">
                            Loading logs...
                        </div>
                    </div>
                    
                    <!-- Real-time Progress Display -->
                    <div class="mb-3" id="progressContainer" style="display: none;">
                        <h6>Pipeline Progress</h6>
                        
                        <!-- Overall Progress Bar -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Overall Completion</span>
                                <span id="progressPercentage">0%</span>
                            </div>
                            <div class="progress">
                                <div 
                                    class="progress-bar progress-bar-striped progress-bar-animated" 
                                    id="progressBar"
                                    role="progressbar" 
                                    style="width: 0%">
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-1">
                                <small class="text-muted" id="etaDisplay">ETA: calculating...</small>
                            </div>
                        </div>
                        
                        <!-- Stage Indicators -->
                        <div class="mb-3">
                            <h6 class="small">Pipeline Stages</h6>
                            <div id="stageIndicators">
                                <div class="stage-item" data-stage="initialization">
                                    <span class="badge bg-secondary">‚è∏</span> Initialization
                                </div>
                                <div class="stage-item" data-stage="judge">
                                    <span class="badge bg-secondary">‚è∏</span> Judge Validation
                                </div>
                                <div class="stage-item" data-stage="deep_review">
                                    <span class="badge bg-secondary">‚è∏</span> Deep Review
                                    <span class="iteration-counter" style="display: none;"></span>
                                </div>
                                <div class="stage-item" data-stage="gap_analysis">
                                    <span class="badge bg-secondary">‚è∏</span> Gap Analysis
                                    <span class="iteration-counter" style="display: none;"></span>
                                </div>
                                <div class="stage-item" data-stage="visualization">
                                    <span class="badge bg-secondary">‚è∏</span> Visualization
                                </div>
                                <div class="stage-item" data-stage="finalization">
                                    <span class="badge bg-secondary">‚è∏</span> Finalization
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Logs -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="small mb-0">Live Logs</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                                        Clear
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleAutoScroll()">
                                        <span id="autoScrollIcon">üîí</span> Auto-scroll
                                    </button>
                                </div>
                            </div>
                            <div class="log-viewer-live" id="liveLogViewer">
                                <div class="text-muted text-center p-3">
                                    Waiting for logs...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legacy Progress Section (kept for backward compatibility) -->
                    <div class="mb-3" id="progressSection" style="display: none;">
                        <strong>Progress:</strong>
                        <div id="detailProgress"></div>
                    </div>
                    
                    <!-- Prompt History Section -->
                    <div class="mb-3" id="promptHistorySection" style="display: none;">
                        <h6>User Decisions</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Prompt Type</th>
                                        <th>Response</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="promptHistoryTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Enhanced Analytical Outputs Section -->
                    <div id="enhancedOutputsSection" style="display: none;">
                        <h5 class="section-title">üìä Enhanced Analysis</h5>
                        
                        <div class="enhanced-cards-grid">
                            
                            <!-- Proof Scorecard Card -->
                            <div id="proofScorecardCard" style="display: none;" class="enhanced-card proof-scorecard-card">
                                <div class="card-header">
                                    <span class="card-icon">üéØ</span>
                                    <h4>Proof Completeness Scorecard</h4>
                                </div>
                                <div class="card-body">
                                    <div id="scoreCircle" class="score-circle">
                                        <div class="score-value" id="scoreValue">0%</div>
                                        <div class="score-label">Ready</div>
                                    </div>
                                    <div id="verdictBadge" class="verdict-badge">
                                        UNKNOWN
                                    </div>
                                    <p class="headline" id="scoreHeadline"></p>
                                    
                                    <div class="next-steps" id="nextStepsSection" style="display: none;">
                                        <strong>Top Priorities:</strong>
                                        <ul id="nextStepsList">
                                        </ul>
                                    </div>
                                    
                                    <a id="proofReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üìÑ View Full Report
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Cost Summary Card -->
                            <div id="costSummaryCard" style="display: none;" class="enhanced-card cost-summary-card">
                                <div class="card-header">
                                    <span class="card-icon">üí∞</span>
                                    <h4>API Cost Summary</h4>
                                </div>
                                <div class="card-body">
                                    <div class="cost-metrics">
                                        <div class="metric-row">
                                            <span class="metric-label">Total Cost:</span>
                                            <span class="metric-value cost-total" id="totalCost">
                                                $0.00
                                            </span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Per Paper:</span>
                                            <span class="metric-value" id="perPaperCost">
                                                $0.00
                                            </span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Budget Used:</span>
                                            <span class="metric-value">
                                                <div class="progress-bar-container">
                                                    <div class="progress-bar" id="budgetBar" style="width: 0%">
                                                    </div>
                                                    <span class="progress-text" id="budgetPercent">
                                                        0.0%
                                                    </span>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="metric-row" id="cacheSavingsRow" style="display: none;">
                                            <span class="metric-label">Cache Savings:</span>
                                            <span class="metric-value savings" id="cacheSavings">
                                                -$0.00
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <a id="costReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üìä View Breakdown
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Sufficiency Matrix Card -->
                            <div id="sufficiencyCard" style="display: none;" class="enhanced-card sufficiency-card">
                                <div class="card-header">
                                    <span class="card-icon">üìà</span>
                                    <h4>Evidence Sufficiency Matrix</h4>
                                </div>
                                <div class="card-body">
                                    <div class="quadrant-grid">
                                        <div class="quadrant q1" id="quadrantQ1" style="display: none;">
                                            <div class="quadrant-name">Strong Foundation</div>
                                            <div class="quadrant-count" id="countQ1">0</div>
                                        </div>
                                        <div class="quadrant q2" id="quadrantQ2" style="display: none;">
                                            <div class="quadrant-name">Promising Seeds</div>
                                            <div class="quadrant-count" id="countQ2">0</div>
                                        </div>
                                        <div class="quadrant q3" id="quadrantQ3" style="display: none;">
                                            <div class="quadrant-name">Hollow Coverage</div>
                                            <div class="quadrant-count" id="countQ3">0</div>
                                        </div>
                                        <div class="quadrant q4" id="quadrantQ4" style="display: none;">
                                            <div class="quadrant-name">Critical Gaps</div>
                                            <div class="quadrant-count" id="countQ4">0</div>
                                        </div>
                                    </div>
                                    
                                    <div class="recommendations" id="recommendationsSection" style="display: none;">
                                        <strong>Top Recommendations:</strong>
                                        <ul id="recommendationsList">
                                        </ul>
                                    </div>
                                    
                                    <a id="sufficiencyReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üîç View Interactive Matrix
                                    </a>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" id="genealogyBtn" onclick="viewJobGenealogy()">
                        üå≥ View Genealogy
                    </button>
                    <button type="button" class="btn btn-primary" id="downloadBtn">
                        üì• Download PDF
                    </button>
                    <button type="button" class="btn btn-warning" id="retryBtn">
                        üîÑ Retry Job
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Viewer Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        üìä Analysis Results - <span id="resultsJobId"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Sidebar: File browser -->
                        <div class="col-md-3">
                            <h6>Output Files</h6>
                            <div class="list-group" id="resultsFileList" style="max-height: 600px; overflow-y: auto;">
                                <div class="text-center text-muted p-3">
                                    Loading...
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="downloadAllResults()">
                                    üì¶ Download All (ZIP)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Main area: File viewer -->
                        <div class="col-md-9">
                            <div id="resultsViewer">
                                <div class="text-center text-muted p-5">
                                    <h5>Select a file to view</h5>
                                    <p>Choose a file from the list on the left</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Prompt Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        ‚è∏Ô∏è Job Paused - Input Required
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Job ID:</strong> <span id="promptJobId"></span>
                    </div>
                    
                    <h6 id="promptMessage"></h6>
                    
                    <!-- Prompt content (varies by type) -->
                    <div id="promptContent"></div>
                    
                    <!-- Timeout warning -->
                    <div class="alert alert-warning mt-3">
                        ‚è∞ Please respond within <span id="promptTimeout">5:00</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelPrompt()">
                        Cancel Job
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitPromptResponse()">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Warning Modal -->
    <div class="modal fade" id="duplicateWarningModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">‚ö†Ô∏è Duplicate Papers Detected</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-warning">
                        <strong><span id="duplicate-count">0</span> of <span id="total-count">0</span> papers already exist</strong> in your database.
                    </p>
                    
                    <h6>Duplicates Found:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Paper Title</th>
                                    <th>Match Type</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-list">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-3">New Papers (<span id="new-count">0</span>):</h6>
                    <ul id="new-papers-list" class="list-group">
                        <!-- Populated dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel Upload</button>
                    <button type="button" class="btn btn-primary" onclick="handleDuplicates('skip_duplicates')">
                        Skip Duplicates (Upload <span id="new-count-btn">0</span> New)
                    </button>
                    <button type="button" class="btn btn-danger" onclick="handleDuplicates('overwrite_all')">
                        Overwrite All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal fade" id="comparisonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üìä Compare Gap Analysis Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Job Selector -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="baseline-job" class="form-label"><strong>Baseline Job (Earlier Run)</strong></label>
                            <select id="baseline-job" class="form-select">
                                <option value="">-- Select a job --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="comparison-job" class="form-label"><strong>Comparison Job (Later Run)</strong></label>
                            <select id="comparison-job" class="form-select">
                                <option value="">-- Select a job --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" onclick="loadComparison()">
                                Compare Jobs
                            </button>
                        </div>
                    </div>
                    
                    <!-- Comparison Results -->
                    <div id="comparison-results" style="display: none;">
                        <!-- Populated via JavaScript -->
                    </div>
                    
                    <div id="comparison-error" class="alert alert-danger" style="display: none;">
                        <!-- Error messages -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">‚ö†Ô∏è Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Delete <span id="deleteJobCount">0</span> job(s)?</strong></p>
                    <p>This will permanently delete the following jobs and all associated data:</p>
                    <ul id="deleteJobList" class="list-group mb-3">
                        <!-- Job list populated by JavaScript -->
                    </ul>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. All analysis results, logs, and uploaded files will be permanently deleted.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelDelete">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete Permanently</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Comparison Results Modal -->
    <div class="modal fade" id="bulkComparisonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">üìä Job Comparison</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Aggregate Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Average Coverage</h6>
                                    <h3 id="avgCoverage">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Total Papers</h6>
                                    <h3 id="totalPapers">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Coverage Range</h6>
                                    <h3 id="coverageRange">-</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Metric</th>
                                    <th colspan="5">Jobs</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress History Modal -->
    <div class="modal fade" id="progressHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        ‚è±Ô∏è Progress Timeline - Job <span id="history-job-id"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Total Duration Summary -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total Duration:</strong> <span id="total-duration"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Slowest Stage:</strong> <span id="slowest-stage"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline Visualization -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Timeline Visualization</strong>
                        </div>
                        <div class="card-body">
                            <canvas id="timeline-chart" style="height: 150px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Stage Details Table -->
                    <h6 class="mt-4">Stage Breakdown</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Stage</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                    <th>% of Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="stage-details">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportProgressReport()">
                        üì• Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Browser Modal -->
    <div class="modal fade" id="resultsBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        üîç Browse All Results
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="input-group">
                                <span class="input-group-text">üîé</span>
                                <input type="text" id="resultsSearchInput" class="form-control" placeholder="Search by name, date, or pillar...">
                                <select id="resultsFilterSelect" class="form-select" style="max-width: 200px;">
                                    <option value="all">All Results</option>
                                    <option value="dashboard">Dashboard Jobs</option>
                                    <option value="imported">Imported Results</option>
                                    <option value="completed">Completed Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results List -->
                    <div id="allResultsList" class="list-group">
                        <div class="text-center text-muted p-4">
                            Loading results...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="refreshResultsBrowser()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory File List Modal (PARITY-W3-2) -->
    <div class="modal fade" id="fileListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">üìã Files in Directory</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Summary -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <strong id="fileListPdfCount">0</strong> PDFs
                        </div>
                        <div class="col-4">
                            <strong id="fileListCsvCount">0</strong> CSVs
                        </div>
                        <div class="col-4">
                            <strong id="fileListTotalSize">0 KB</strong> Total
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="fileListSearch" 
                               placeholder="Search files..." oninput="filterFileList()">
                    </div>
                    
                    <!-- File List Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="fileListTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th onclick="sortFileList('filename')" style="cursor: pointer;">
                                        Filename ‚Üï
                                    </th>
                                    <th onclick="sortFileList('type')" style="cursor: pointer;">
                                        Type ‚Üï
                                    </th>
                                    <th onclick="sortFileList('size')" style="cursor: pointer;">
                                        Size ‚Üï
                                    </th>
                                    <th onclick="sortFileList('path')" style="cursor: pointer;">
                                        Path ‚Üï
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="fileListBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Continuation Mode CSS -->
    <link rel="stylesheet" href="/static/css/continuation.css">
    
    <!-- Resource Monitoring JavaScript -->
    <script src="/static/js/resource_monitor.js"></script>
    
    <!-- Bulk Operations JavaScript -->
    <script src="/static/js/bulk_operations.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${WS_PROTOCOL}//${window.location.host}/ws/jobs`;
        
        // Force re-analysis configuration
        const DEFAULT_PAPER_COUNT_ESTIMATE = 10;  // Default estimate when actual count unknown
        const CACHE_HIT_RATE = 0.8;  // Expected 80% cache hit rate
        
        // State
        let jobs = [];
        let ws = null;
        let apiKey = 'dev-key-change-in-production';
        let currentJobId = null;
        
        // WebSocket connection
        function connectWebSocket() {
            const wsStatus = document.getElementById('wsStatus');
            wsStatus.textContent = 'Connecting...';
            wsStatus.className = 'badge bg-warning';
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                wsStatus.textContent = 'Connected';
                wsStatus.className = 'badge bg-success';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                if (data.type === 'initial_state') {
                    jobs = data.jobs || [];
                    updateJobsTable();
                    updateMetrics();
                } else if (data.type === 'job_created' || data.type === 'job_update' || data.type === 'job_retry') {
                    updateJob(data.job);
                } else if (data.type === 'prompt_request') {
                    showPrompt(data);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                wsStatus.textContent = 'Disconnected';
                wsStatus.className = 'badge bg-danger';
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Progress WebSocket for job-specific real-time updates
        let progressWebSocket = null;
        let autoScroll = true;
        
        function connectProgressWebSocket(jobId) {
            // Close existing connection
            if (progressWebSocket) {
                progressWebSocket.close();
            }
            
            // Connect to job-specific progress stream
            const wsUrl = `${WS_PROTOCOL}//${window.location.host}/ws/jobs/${jobId}/progress`;
            progressWebSocket = new WebSocket(wsUrl);
            
            progressWebSocket.onopen = () => {
                console.log('Progress WebSocket connected');
                document.getElementById('progressContainer').style.display = 'block';
            };
            
            progressWebSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'initial_status':
                        handleInitialStatus(data.job);
                        break;
                    case 'progress':
                        handleProgressEvent(data.event);
                        break;
                    case 'logs':
                        handleLogLines(data.lines);
                        break;
                    case 'job_complete':
                        handleJobComplete(data.status);
                        break;
                }
            };
            
            progressWebSocket.onerror = (error) => {
                console.error('Progress WebSocket error:', error);
            };
            
            progressWebSocket.onclose = () => {
                console.log('Progress WebSocket disconnected');
            };
        }
        
        function handleInitialStatus(job) {
            console.log('Initial job status:', job);
        }
        
        function handleProgressEvent(event) {
            // Update progress bar
            if (event.percentage !== null && event.percentage !== undefined) {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = document.getElementById('progressPercentage');
                
                progressBar.style.width = event.percentage + '%';
                progressPercentage.textContent = event.percentage.toFixed(1) + '%';
            }
            
            // Update ETA display
            if (event.metadata && event.metadata.eta_seconds) {
                const etaElement = document.getElementById('etaDisplay');
                if (etaElement) {
                    const minutes = Math.floor(event.metadata.eta_seconds / 60);
                    const seconds = Math.floor(event.metadata.eta_seconds % 60);
                    etaElement.textContent = `ETA: ${minutes}m ${seconds}s`;
                }
            }
            
            // Update stage indicator
            const stageItem = document.querySelector(`[data-stage="${event.stage}"]`);
            if (stageItem) {
                const badge = stageItem.querySelector('.badge');
                const iterationCounter = stageItem.querySelector('.iteration-counter');
                
                // Remove all status classes
                stageItem.classList.remove('active', 'complete', 'error');
                
                switch (event.phase) {
                    case 'starting':
                    case 'running':
                        stageItem.classList.add('active');
                        badge.className = 'badge bg-primary';
                        badge.textContent = '‚è≥';
                        break;
                    case 'complete':
                        stageItem.classList.add('complete');
                        badge.className = 'badge bg-success';
                        badge.textContent = '‚úÖ';
                        break;
                    case 'error':
                        stageItem.classList.add('error');
                        badge.className = 'badge bg-danger';
                        badge.textContent = '‚ùå';
                        break;
                }
                
                // Show iteration counter if present
                if (event.metadata && event.metadata.iteration) {
                    iterationCounter.textContent = `(Iteration ${event.metadata.iteration})`;
                    iterationCounter.style.display = 'inline';
                }
            }
            
            // Add log line for event
            appendLogLine(`[${event.stage}] ${event.message}`, getLogClass(event.phase));
        }
        
        function handleLogLines(lines) {
            lines.forEach(line => {
                appendLogLine(line.trim());
            });
        }
        
        function appendLogLine(text, cssClass = '') {
            const logViewer = document.getElementById('liveLogViewer');
            
            // Remove "waiting" message if present
            if (logViewer.querySelector('.text-muted')) {
                logViewer.innerHTML = '';
            }
            
            const logLine = document.createElement('div');
            logLine.className = 'log-line ' + cssClass;
            logLine.textContent = text;
            
            logViewer.appendChild(logLine);
            
            // Auto-scroll if enabled
            if (autoScroll) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        }
        
        function getLogClass(phase) {
            switch (phase) {
                case 'error':
                    return 'error';
                case 'complete':
                    return 'success';
                case 'running':
                    return '';
                default:
                    return '';
            }
        }
        
        function clearLogs() {
            document.getElementById('liveLogViewer').innerHTML = '';
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const icon = document.getElementById('autoScrollIcon');
            icon.textContent = autoScroll ? 'üîí' : 'üîì';
        }
        
        function handleJobComplete(status) {
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.remove('progress-bar-animated');
            
            if (status === 'completed') {
                progressBar.classList.add('bg-success');
                progressBar.style.width = '100%';
                document.getElementById('progressPercentage').textContent = '100%';
            } else {
                progressBar.classList.add('bg-danger');
            }
        }
        
        // Update or add job in state
        function updateJob(job) {
            const index = jobs.findIndex(j => j.id === job.id);
            if (index >= 0) {
                jobs[index] = job;
            } else {
                jobs.unshift(job);
            }
            updateJobsTable();
            updateMetrics();
        }
        
        // Update metrics display
        function updateMetrics() {
            const total = jobs.length;
            const completed = jobs.filter(j => j.status === 'completed').length;
            const running = jobs.filter(j => j.status === 'running').length;
            const failed = jobs.filter(j => j.status === 'failed').length;
            
            document.getElementById('totalJobs').textContent = total;
            document.getElementById('completedJobs').textContent = completed;
            document.getElementById('runningJobs').textContent = running;
            document.getElementById('failedJobs').textContent = failed;
        }
        
        // Format date/time
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        // Calculate duration
        function calculateDuration(startTime, endTime) {
            if (!startTime) return '-';
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / 60000);
            const diffSecs = Math.floor((diffMs % 60000) / 1000);
            return `${diffMins}m ${diffSecs}s`;
        }
        
        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'draft': 'bg-info',
                'queued': 'bg-secondary',
                'running': 'bg-primary',
                'completed': 'bg-success',
                'failed': 'bg-danger'
            };
            const className = badges[status] || 'bg-secondary';
            return `<span class="badge ${className} status-badge">${status.toUpperCase()}</span>`;
        }
        
        // Update jobs table
        function updateJobsTable() {
            const container = document.getElementById('jobsContainer');
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        No jobs yet. Upload a PDF to get started.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => {
                const summary = job.summary || {
                    completeness: 0,
                    critical_gaps: 0,
                    paper_count: 0,
                    recommendations_preview: [],
                    has_results: false
                };
                
                const summaryCardsHtml = summary.has_results ? `
                    <div class="job-summary-cards">
                        <div class="summary-card completeness ${getCompletenessClass(summary.completeness)}">
                            <div class="metric-icon">üìä</div>
                            <div class="metric-value">${summary.completeness}%</div>
                            <div class="metric-label">Coverage</div>
                        </div>
                        
                        <div class="summary-card critical-gaps ${summary.critical_gaps > 0 ? 'has-alerts' : ''}">
                            <div class="metric-icon">‚ö†Ô∏è</div>
                            <div class="metric-value">${summary.critical_gaps}</div>
                            <div class="metric-label">Critical Gaps</div>
                        </div>
                        
                        <div class="summary-card paper-count">
                            <div class="metric-icon">üìÑ</div>
                            <div class="metric-value">${summary.paper_count}</div>
                            <div class="metric-label">Papers</div>
                        </div>
                        
                        <div class="summary-card recommendations">
                            <div class="metric-icon">üí°</div>
                            <div class="metric-value">${summary.recommendations_preview.length}</div>
                            <div class="metric-label">Recommendations</div>
                            ${summary.recommendations_preview.length > 0 ? `
                                <div class="metric-preview">
                                    <ul>
                                        ${summary.recommendations_preview.map(rec => `
                                            <li>${rec.substring(0, 50)}...</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : `
                    <div class="job-summary-cards">
                        <div class="summary-card no-results">
                            <span>Analysis pending or in progress</span>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="job-item" data-job-id="${job.id}">
                        <div class="job-header">
                            <div class="d-flex align-items-center gap-2">
                                <input type="checkbox" class="form-check-input job-checkbox" data-job-id="${job.id}">
                                <h5 class="mb-0"><code>${job.id.substring(0, 8)}</code> - ${job.filename || 'Batch Upload'}</h5>
                            </div>
                            <div>
                                ${getStatusBadge(job.status)}
                            </div>
                        </div>
                        
                        ${summaryCardsHtml}
                        
                        <div class="job-details">
                            <small class="text-muted">
                                Created: ${formatDateTime(job.created_at)} | 
                                Duration: ${calculateDuration(job.started_at || job.created_at, job.completed_at)}
                            </small>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="showJobDetail('${job.id}')">
                                    View Details
                                </button>
                                ${job.status === 'draft' ? `
                                    <button class="btn btn-sm btn-success" onclick="configureAndStartJob('${job.id}', '${job.filename || 'Batch Upload'}')">
                                        ‚öôÔ∏è Configure & Start
                                    </button>
                                ` : ''}
                                ${job.status === 'completed' ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="showJobResults('${job.id}')">
                                        üìä Full Results
                                    </button>
                                ` : ''}
                                ${job.status === 'running' ? `
                                    <button class="btn btn-sm btn-warning" onclick="cancelJob('${job.id}')">
                                        ‚è∏Ô∏è Cancel
                                    </button>
                                ` : ''}
                                ${job.status === 'failed' ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="retryJob('${job.id}')">
                                        üîÑ Retry
                                    </button>
                                ` : ''}
                                ${['draft', 'completed', 'failed'].includes(job.status) ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('${job.id}')">
                                        üóëÔ∏è Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper function for completeness color coding
        function getCompletenessClass(completeness) {
            if (completeness >= 80) return 'bg-success';
            if (completeness >= 60) return 'bg-warning';
            return 'bg-danger';
        }
        
        // Helper methods for enhanced outputs
        function getScoreClass(score) {
            if (score >= 60) return 'score-high';
            if (score >= 40) return 'score-medium';
            return 'score-low';
        }

        function getVerdictClass(verdict) {
            const verdictMap = {
                'STRONG': 'verdict-strong',
                'MODERATE': 'verdict-moderate',
                'WEAK': 'verdict-weak',
                'INSUFFICIENT': 'verdict-insufficient'
            };
            return verdictMap[verdict] || 'verdict-unknown';
        }

        function getBudgetClass(percent) {
            if (percent > 80) return 'budget-high';
            if (percent > 50) return 'budget-medium';
            return 'budget-low';
        }

        // Fetch enhanced outputs for a job
        async function fetchEnhancedOutputs(jobId, apiKey) {
            try {
                const [proofRes, costRes, sufficiencyRes] = await Promise.all([
                    fetch(`${API_BASE}/api/jobs/${jobId}/proof-scorecard`, {
                        headers: {'X-API-KEY': apiKey}
                    }),
                    fetch(`${API_BASE}/api/jobs/${jobId}/cost-summary`, {
                        headers: {'X-API-KEY': apiKey}
                    }),
                    fetch(`${API_BASE}/api/jobs/${jobId}/sufficiency-summary`, {
                        headers: {'X-API-KEY': apiKey}
                    })
                ]);
                
                let hasAnyOutput = false;
                
                // Process proof scorecard
                if (proofRes.ok) {
                    const proofData = await proofRes.json();
                    if (proofData.available) {
                        hasAnyOutput = true;
                        displayProofScorecard(proofData);
                    }
                }
                
                // Process cost summary
                if (costRes.ok) {
                    const costData = await costRes.json();
                    if (costData.available) {
                        hasAnyOutput = true;
                        displayCostSummary(costData);
                    }
                }
                
                // Process sufficiency summary
                if (sufficiencyRes.ok) {
                    const sufficiencyData = await sufficiencyRes.json();
                    if (sufficiencyData.available) {
                        hasAnyOutput = true;
                        displaySufficiencySummary(sufficiencyData);
                    }
                }
                
                // Show enhanced outputs section if any output is available
                if (hasAnyOutput) {
                    document.getElementById('enhancedOutputsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to fetch enhanced outputs:', error);
            }
        }

        function displayProofScorecard(data) {
            const card = document.getElementById('proofScorecardCard');
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const verdictBadge = document.getElementById('verdictBadge');
            const headline = document.getElementById('scoreHeadline');
            const reportLink = document.getElementById('proofReportLink');
            
            // Update score
            scoreValue.textContent = data.overall_score + '%';
            scoreCircle.className = 'score-circle ' + getScoreClass(data.overall_score);
            
            // Update verdict
            verdictBadge.textContent = data.verdict;
            verdictBadge.className = 'verdict-badge ' + getVerdictClass(data.verdict);
            
            // Update headline
            headline.textContent = data.headline;
            
            // Update next steps
            if (data.next_steps && data.next_steps.length > 0) {
                const nextStepsList = document.getElementById('nextStepsList');
                nextStepsList.innerHTML = data.next_steps.slice(0, 3).map(step => 
                    `<li>${step}</li>`
                ).join('');
                document.getElementById('nextStepsSection').style.display = 'block';
            }
            
            // Update report link
            reportLink.href = data.html_path;
            
            card.style.display = 'block';
        }

        function displayCostSummary(data) {
            const card = document.getElementById('costSummaryCard');
            
            // Update costs
            document.getElementById('totalCost').textContent = '$' + data.total_cost.toFixed(2);
            document.getElementById('perPaperCost').textContent = '$' + data.per_paper_cost.toFixed(2);
            
            // Update budget bar
            const budgetBar = document.getElementById('budgetBar');
            const budgetPercent = document.getElementById('budgetPercent');
            budgetBar.style.width = data.budget_percent + '%';
            budgetBar.className = 'progress-bar ' + getBudgetClass(data.budget_percent);
            budgetPercent.textContent = data.budget_percent.toFixed(1) + '%';
            
            // Show cache savings if > 0
            if (data.cache_savings > 0) {
                document.getElementById('cacheSavings').textContent = '-$' + data.cache_savings.toFixed(2);
                document.getElementById('cacheSavingsRow').style.display = 'flex';
            }
            
            // Update report link
            document.getElementById('costReportLink').href = data.html_path;
            
            card.style.display = 'block';
        }

        function displaySufficiencySummary(data) {
            const card = document.getElementById('sufficiencyCard');
            
            // Update quadrants
            const quadrantMap = {
                'Q1-Strong-Foundation': ['quadrantQ1', 'countQ1'],
                'Q2-Promising-Seeds': ['quadrantQ2', 'countQ2'],
                'Q3-Hollow-Coverage': ['quadrantQ3', 'countQ3'],
                'Q4-Critical-Gaps': ['quadrantQ4', 'countQ4']
            };
            
            for (const [quadrant, [quadrantId, countId]] of Object.entries(quadrantMap)) {
                if (data.quadrants[quadrant] !== undefined) {
                    document.getElementById(countId).textContent = data.quadrants[quadrant];
                    document.getElementById(quadrantId).style.display = 'block';
                }
            }
            
            // Update recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                const recList = document.getElementById('recommendationsList');
                recList.innerHTML = data.recommendations.slice(0, 2).map(rec => 
                    `<li>${rec}</li>`
                ).join('');
                document.getElementById('recommendationsSection').style.display = 'block';
            }
            
            // Update report link
            document.getElementById('sufficiencyReportLink').href = data.html_path;
            
            card.style.display = 'block';
        }
        
        // Show job detail modal
        async function showJobDetail(jobId) {
            currentJobId = jobId;
            
            // Get current API key from input
            const currentApiKey = document.getElementById('apiKeyInput').value;
            
            try {
                // Fetch job details
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                    headers: {
                        'X-API-KEY': currentApiKey
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch job details');
                
                const job = await response.json();
                
                // Update modal content
                document.getElementById('detailJobId').textContent = job.id;
                document.getElementById('detailStatus').innerHTML = getStatusBadge(job.status);
                document.getElementById('detailFilename').textContent = job.filename;
                document.getElementById('detailCreated').textContent = formatDateTime(job.created_at);
                
                // Show error if exists
                const errorSection = document.getElementById('errorSection');
                if (job.error) {
                    document.getElementById('detailError').textContent = job.error;
                    errorSection.style.display = 'block';
                } else {
                    errorSection.style.display = 'none';
                }
                
                // Show progress if exists
                const progressSection = document.getElementById('progressSection');
                if (job.progress && Object.keys(job.progress).length > 0) {
                    document.getElementById('detailProgress').textContent = JSON.stringify(job.progress, null, 2);
                    progressSection.style.display = 'block';
                } else {
                    progressSection.style.display = 'none';
                }
                
                // Show prompt history if exists
                const promptHistorySection = document.getElementById('promptHistorySection');
                if (job.prompts && job.prompts.length > 0) {
                    const tbody = document.getElementById('promptHistoryTable');
                    tbody.innerHTML = job.prompts.map(p => {
                        const timestamp = new Date(p.timestamp).toLocaleString();
                        const statusBadge = p.timed_out 
                            ? '<span class="badge bg-danger">Timed Out</span>' 
                            : '<span class="badge bg-success">Responded</span>';
                        
                        return `
                            <tr>
                                <td>${timestamp}</td>
                                <td><span class="badge bg-info">${p.type}</span></td>
                                <td><strong>${p.response || 'N/A'}</strong></td>
                                <td>${statusBadge}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="text-muted small">
                                    ${p.prompt_data.message || ''}
                                    ${p.timed_out ? ` (${p.timeout_seconds}s timeout)` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    promptHistorySection.style.display = 'block';
                } else {
                    promptHistorySection.style.display = 'none';
                }
                
                // Fetch logs
                const logsResponse = await fetch(`${API_BASE}/api/logs/${jobId}?tail=100`, {
                    headers: {
                        'X-API-KEY': currentApiKey
                    }
                });
                
                if (logsResponse.ok) {
                    const logsData = await logsResponse.json();
                    document.getElementById('detailLogs').textContent = logsData.logs || 'No logs available';
                } else {
                    document.getElementById('detailLogs').textContent = 'Failed to load logs';
                }
                
                // Hide all enhanced output cards initially
                document.getElementById('enhancedOutputsSection').style.display = 'none';
                document.getElementById('proofScorecardCard').style.display = 'none';
                document.getElementById('costSummaryCard').style.display = 'none';
                document.getElementById('sufficiencyCard').style.display = 'none';
                document.getElementById('nextStepsSection').style.display = 'none';
                document.getElementById('cacheSavingsRow').style.display = 'none';
                document.getElementById('recommendationsSection').style.display = 'none';
                
                // Fetch enhanced outputs if job is completed
                if (job.status === 'completed') {
                    await fetchEnhancedOutputs(jobId, currentApiKey);
                }
                
                // Connect to progress stream if job is running or queued
                if (job.status === 'running' || job.status === 'queued') {
                    connectProgressWebSocket(jobId);
                } else {
                    // Hide progress container for completed/failed jobs
                    document.getElementById('progressContainer').style.display = 'none';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error fetching job details:', error);
                alert('Failed to load job details: ' + error.message);
            }
        }
        
        // Upload form handler - Batch upload with configuration
        document.getElementById('batchUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Determine which mode is selected
            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            const fileInput = uploadMode === 'files' 
                ? document.getElementById('batchFileInput')
                : document.getElementById('folderInput');
            
            let files = Array.from(fileInput.files);
            
            // Filter for PDFs only if folder mode
            if (uploadMode === 'folder') {
                files = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
                
                if (files.length === 0) {
                    alert('No PDF files found in the selected folder');
                    return;
                }
                
                console.log(`Found ${files.length} PDFs in folder`);
            }
            
            if (files.length === 0) {
                alert('Please select at least one PDF file');
                return;
            }
            
            // Update API key from input
            apiKey = document.getElementById('apiKeyInput').value;
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`${API_BASE}/api/upload/batch`, {
                    method: 'POST',
                    headers: { 'X-API-KEY': apiKey },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const result = await response.json();
                
                // Check if duplicates were found
                if (result.status === 'duplicates_found') {
                    showDuplicateWarning(result);
                } else {
                    // Show configuration modal
                    currentJobId = result.job_id;
                    document.getElementById('configJobId').textContent = result.job_id;
                    document.getElementById('configFileCount').textContent = result.file_count;
                    
                    const modal = new bootstrap.Modal(document.getElementById('configModal'));
                    modal.show();
                }
                
                // Reset form
                fileInput.value = '';
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });
        
        // Store upload data globally for duplicate confirmation
        let uploadData = null;
        
        // Show duplicate warning modal
        function showDuplicateWarning(data) {
            uploadData = data;
            
            // Update counts
            document.getElementById('duplicate-count').textContent = data.duplicates.length;
            document.getElementById('total-count').textContent = data.duplicates.length + data.new.length;
            document.getElementById('new-count').textContent = data.new.length;
            document.getElementById('new-count-btn').textContent = data.new.length;
            
            // Populate duplicate list
            const tbody = document.getElementById('duplicate-list');
            tbody.innerHTML = '';
            for (let dup of data.duplicates) {
                const matchInfo = dup.match_info || {};
                const method = matchInfo.method || 'unknown';
                const confidence = matchInfo.confidence || 0;
                
                let methodBadge = '';
                switch(method) {
                    case 'hash':
                        methodBadge = '<span class="badge bg-danger">Exact File Match</span>';
                        break;
                    case 'exact_title':
                        methodBadge = '<span class="badge bg-warning">Title Match</span>';
                        break;
                    case 'fuzzy_title':
                        methodBadge = '<span class="badge bg-info">Similar Title</span>';
                        break;
                    default:
                        methodBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                const row = `
                    <tr>
                        <td>${dup.title || dup.original_name}</td>
                        <td>${methodBadge}</td>
                        <td>${(confidence * 100).toFixed(1)}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
            
            // Populate new papers list
            const newList = document.getElementById('new-papers-list');
            newList.innerHTML = '';
            for (let paper of data.new) {
                const item = `<li class="list-group-item">${paper.title || paper.original_name}</li>`;
                newList.innerHTML += item;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('duplicateWarningModal'));
            modal.show();
        }
        
        // Handle duplicate confirmation
        async function handleDuplicates(action) {
            if (!uploadData) {
                alert('No upload data available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/upload/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        action: action,
                        job_id: uploadData.job_id
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Confirmation failed');
                }
                
                const result = await response.json();
                
                // Hide duplicate modal
                const duplicateModal = bootstrap.Modal.getInstance(document.getElementById('duplicateWarningModal'));
                duplicateModal.hide();
                
                // Show success message
                alert(result.message);
                
                // Show configuration modal if there are files to configure
                if (result.uploaded > 0) {
                    currentJobId = uploadData.job_id;
                    document.getElementById('configJobId').textContent = uploadData.job_id;
                    document.getElementById('configFileCount').textContent = result.uploaded;
                    
                    const configModal = new bootstrap.Modal(document.getElementById('configModal'));
                    configModal.show();
                } else {
                    // No files to configure, WebSocket will update job list automatically
                    console.log('Upload confirmed, waiting for WebSocket update');
                }
                
                // Clear upload data
                uploadData = null;
                
            } catch (error) {
                alert('Failed to confirm upload: ' + error.message);
            }
        }
        
        // Load pillar definitions and populate checkboxes
        async function loadPillarDefinitions() {
            try {
                const response = await fetch('/static/pillar_definitions.json');
                const definitions = await response.json();
                
                const container = document.getElementById('pillarCheckboxes');
                container.innerHTML = '';
                
                // Filter out metadata sections
                const metadata = ['Framework_Overview', 'Cross_Cutting_Requirements', 'Success_Criteria'];
                
                for (const [key, value] of Object.entries(definitions)) {
                    if (metadata.includes(key)) continue;
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'form-check';
                    checkbox.innerHTML = `
                        <input 
                            class="form-check-input pillar-checkbox-individual" 
                            type="checkbox" 
                            value="${key}" 
                            id="pillar_${key.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <label class="form-check-label" for="pillar_${key.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${key.replace(/_/g, ' ')}
                        </label>
                    `;
                    container.appendChild(checkbox);
                }
            } catch (error) {
                console.error('Failed to load pillar definitions:', error);
            }
        }
        
        // Update threshold display
        function updateThresholdDisplay(value) {
            document.getElementById('relevanceThresholdValue').value = value;
        }
        
        // Update force warning visibility and cost estimate
        function updateForceWarning() {
            const forceEnabled = document.getElementById('forceReanalysis').checked;
            const warning = document.getElementById('forceWarning');
            
            if (forceEnabled) {
                warning.style.display = 'block';
                estimateForceCost();
            } else {
                warning.style.display = 'none';
                document.getElementById('forceConfirm').checked = false;
            }
        }
        
        // Estimate cost impact of forcing re-analysis
        async function estimateForceCost() {
            try {
                // Get uploaded file count from current job
                const fileCount = getUploadedFileCount();
                
                const apiKey = document.getElementById('apiKeyInput').value;
                const response = await fetch(`${API_BASE}/api/cost/estimate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        paper_count: fileCount || DEFAULT_PAPER_COUNT_ESTIMATE,
                        use_cache: false  // Force fresh
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Cost estimation failed');
                }
                
                const estimate = await response.json();
                
                // Update display
                document.getElementById('cachedCost').textContent = 
                    estimate.cached_cost.toFixed(2);
                document.getElementById('freshCost').textContent = 
                    estimate.fresh_cost.toFixed(2);
                document.getElementById('costDiff').textContent = 
                    (estimate.fresh_cost - estimate.cached_cost).toFixed(2);
                    
            } catch (error) {
                console.error('Cost estimation failed:', error);
                // Show generic warning - hide specific cost estimate
                document.getElementById('costEstimate').style.display = 'none';
            }
        }

        // ===== Resume Controls Functions =====

        // Toggle resume from stage controls
        function toggleResumeStage() {
            const enabled = document.getElementById('enableResumeStage').checked;
            document.getElementById('resumeStage').disabled = !enabled;
            
            if (enabled) {
                document.getElementById('enableResumeCheckpoint').checked = false;
                toggleResumeCheckpoint();
                document.getElementById('stageProgressDiagram').style.display = 'block';
                updateStageHighlight();
            } else {
                document.getElementById('stageProgressDiagram').style.display = 'none';
                resetStageHighlight();
            }
            
            checkResumeConflict();
        }

        // Toggle resume from checkpoint controls
        function toggleResumeCheckpoint() {
            const enabled = document.getElementById('enableResumeCheckpoint').checked;
            document.getElementById('checkpointInputSection').style.display = 
                enabled ? 'block' : 'none';
            
            if (enabled) {
                document.getElementById('enableResumeStage').checked = false;
                document.getElementById('stageProgressDiagram').style.display = 'none';
                resetStageHighlight();
            }
            
            checkResumeConflict();
        }

        // Check for mutual exclusion
        function checkResumeConflict() {
            const stageEnabled = document.getElementById('enableResumeStage').checked;
            const checkpointEnabled = document.getElementById('enableResumeCheckpoint').checked;
            
            document.getElementById('resumeConflictWarning').style.display = 
                (stageEnabled && checkpointEnabled) ? 'block' : 'none';
        }

        // Update stage diagram highlighting
        function updateStageHighlight() {
            const selectedStage = document.getElementById('resumeStage').value;
            const stageMapping = {
                'journal_reviewer': 'journal',
                'judge': 'judge',
                'dra': 'dra',
                'sync': 'sync',
                'orchestrator': 'orch',
                'proof_scorecard': 'proof',
                'sufficiency_matrix': 'suff'
            };
            
            const stages = ['journal_reviewer', 'judge', 'dra', 'sync', 'orchestrator', 'proof_scorecard', 'sufficiency_matrix'];
            const selectedIndex = stages.indexOf(selectedStage);
            
            stages.forEach((stage, index) => {
                const boxId = `stage-${stageMapping[stage]}`;
                const box = document.getElementById(boxId);
                if (!box) return;
                
                box.classList.remove('completed', 'active', 'pending');
                
                if (selectedIndex < 0) {
                    // No selection
                    return;
                }
                
                if (index < selectedIndex) {
                    box.classList.add('completed');
                } else if (index === selectedIndex) {
                    box.classList.add('active');
                } else {
                    box.classList.add('pending');
                }
            });
        }

        function resetStageHighlight() {
            ['journal', 'judge', 'dra', 'sync', 'orch', 'proof', 'suff'].forEach(stage => {
                const box = document.getElementById(`stage-${stage}`);
                if (box) {
                    box.classList.remove('completed', 'active', 'pending');
                }
            });
        }

        // Scan for checkpoint files
        async function scanForCheckpoints() {
            const outputDirMode = document.querySelector('input[name="outputDirMode"]:checked')?.value;
            let outputDir = '';
            
            if (outputDirMode === 'custom') {
                outputDir = document.getElementById('customOutputPath')?.value;
            } else if (outputDirMode === 'existing') {
                outputDir = document.getElementById('existingDirDropdown')?.value;
            } else {
                // Auto mode - use current job directory
                const jobId = currentJobId;
                if (jobId) {
                    outputDir = `workspace/jobs/${jobId}/outputs/gap_analysis_output`;
                }
            }
            
            if (!outputDir) {
                alert('Please select an output directory first');
                return;
            }
            
            try {
                const apiKey = document.getElementById('apiKeyInput').value;
                const response = await fetch(`${API_BASE}/api/checkpoints/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ directory: outputDir })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Failed to scan for checkpoints: ${error.detail}`);
                    return;
                }
                
                const data = await response.json();
                
                if (data.checkpoints.length === 0) {
                    alert('No checkpoint files found in output directory');
                    return;
                }
                
                // Display detected checkpoints
                displayDetectedCheckpoints(data.checkpoints);
                
            } catch (error) {
                console.error('Failed to scan for checkpoints:', error);
                alert('Failed to scan for checkpoints');
            }
        }

        // Display detected checkpoint files
        function displayDetectedCheckpoints(checkpoints) {
            const listContainer = document.getElementById('checkpointList');
            listContainer.innerHTML = '';
            
            checkpoints.forEach(checkpoint => {
                if (!checkpoint.valid) return; // Skip invalid checkpoints
                
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 small">${checkpoint.filename}</h6>
                        <small>${new Date(checkpoint.modified).toLocaleString()}</small>
                    </div>
                    <p class="mb-1 small">
                        Last Stage: <strong>${checkpoint.last_stage}</strong> | 
                        Papers: ${checkpoint.papers_processed}
                    </p>
                `;
                
                item.onclick = (e) => {
                    e.preventDefault();
                    selectCheckpoint(checkpoint);
                };
                
                listContainer.appendChild(item);
            });
            
            document.getElementById('detectedCheckpoints').style.display = 'block';
        }

        // Select a checkpoint
        function selectCheckpoint(checkpoint) {
            document.getElementById('checkpointFilePath').value = checkpoint.path;
            
            // Show preview
            document.getElementById('checkpointCreated').textContent = 
                new Date(checkpoint.modified).toLocaleString();
            document.getElementById('checkpointLastStage').textContent = checkpoint.last_stage;
            document.getElementById('checkpointPapersProcessed').textContent = checkpoint.papers_processed;
            document.getElementById('checkpointResumeFrom').textContent = checkpoint.resume_stage;
            
            document.getElementById('checkpointPreview').style.display = 'block';
        }

        // Handle checkpoint file upload
        async function handleCheckpointUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const checkpoint = JSON.parse(text);
                
                // Validate checkpoint structure
                if (!checkpoint.pipeline_version || !checkpoint.stages) {
                    alert('Invalid checkpoint file format');
                    return;
                }
                
                // Display as selected
                selectCheckpoint({
                    path: file.name,
                    filename: file.name,
                    modified: new Date().toISOString(),
                    last_stage: Object.keys(checkpoint.stages || {}).pop() || 'Unknown',
                    papers_processed: checkpoint.papers_processed || 0,
                    resume_stage: checkpoint.next_stage || 'Unknown'
                });
                
                // Store file for upload
                window.uploadedCheckpointFile = file;
                
            } catch (error) {
                alert('Failed to parse checkpoint file: ' + error.message);
            }
        }

        // Get resume configuration for job configuration
        function getResumeConfig() {
            const config = {
                resume_from_stage: null,
                resume_from_checkpoint: null
            };
            
            if (document.getElementById('enableResumeStage').checked) {
                config.resume_from_stage = document.getElementById('resumeStage').value || null;
            }
            
            if (document.getElementById('enableResumeCheckpoint').checked) {
                config.resume_from_checkpoint = document.getElementById('checkpointFilePath').value || null;
            }
            
            return config;
        }
        
        // Get uploaded file count for current job
        function getUploadedFileCount() {
            // Try to get from upload summary if available
            const uploadSummary = document.getElementById('uploadSummary');
            if (uploadSummary && uploadSummary.textContent) {
                const match = uploadSummary.textContent.match(/(\d+)\s+file/);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            // Default to reasonable estimate
            return DEFAULT_PAPER_COUNT_ESTIMATE;
        }
        
        // Validate force confirmation before submission
        function validateForceOptions() {
            const forceEnabled = document.getElementById('forceReanalysis').checked;
            const confirmed = document.getElementById('forceConfirm').checked;
            
            if (forceEnabled && !confirmed) {
                alert('Please confirm you understand the cost impact of forcing re-analysis.');
                return false;
            }
            
            return true;
        }
        
        // Enable/disable resume controls
        document.addEventListener('DOMContentLoaded', function() {
            const enableResume = document.getElementById('enableResume');
            const resumeStage = document.getElementById('resumeStage');
            const enableCheckpointResume = document.getElementById('enableCheckpointResume');
            const checkpointFile = document.getElementById('checkpointFile');
            
            if (enableResume) {
                enableResume.addEventListener('change', (e) => {
                    resumeStage.disabled = !e.target.checked;
                });
            }
            
            if (enableCheckpointResume) {
                enableCheckpointResume.addEventListener('change', (e) => {
                    checkpointFile.disabled = !e.target.checked;
                });
            }
            
            // Initialize pre-filter configuration (PARITY-W2-5)
            document.querySelectorAll('.section-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedSections);
            });
            
            // Initialize pre-filter display
            updatePreFilterMode();
        });
        
        // Reset all advanced options
        
        // Handle config file upload
        async function handleConfigUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Show preview section
            document.getElementById('configPreview').style.display = 'block';
            document.getElementById('configValidation').style.display = 'block';
            document.getElementById('configDetails').style.display = 'none';
            document.getElementById('configErrors').style.display = 'none';
            
            // Read file
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const configText = e.target.result;
                    const configJSON = JSON.parse(configText);
                    
                    // Validate config
                    await validateConfig(configJSON);
                    
                } catch (error) {
                    showConfigError(['Invalid JSON format: ' + error.message]);
                }
            };
            reader.readAsText(file);
        }
        
        // Validate configuration via API
        async function validateConfig(configJSON) {
            try {
                const response = await fetch('/api/config/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify(configJSON)
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    showConfigDetails(configJSON, result);
                } else {
                    showConfigError(result.errors);
                }
                
            } catch (error) {
                showConfigError(['Validation failed: ' + error.message]);
            }
        }
        
        // Display config details
        function showConfigDetails(configJSON, validation) {
            document.getElementById('configValidation').style.display = 'none';
            document.getElementById('configDetails').style.display = 'block';
            
            // Populate details
            document.getElementById('configVersion').textContent = 
                configJSON.version || 'Unknown';
            
            document.getElementById('configOverrides').innerHTML = 
                `<span class="badge bg-info">${validation.overrides_count || 0} settings</span>`;
            
            // Show full JSON
            document.getElementById('fullConfigJSON').textContent = 
                JSON.stringify(configJSON, null, 2);
        }
        
        // Show validation errors
        function showConfigError(errors) {
            document.getElementById('configValidation').style.display = 'none';
            document.getElementById('configErrors').style.display = 'block';
            
            const errorList = document.getElementById('configErrorList');
            errorList.innerHTML = '';
            
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
        }
        
        // Clear config upload
        function clearConfigUpload() {
            document.getElementById('configFileUpload').value = '';
            document.getElementById('configPreview').style.display = 'none';
        }
        
        // Include config in job submission
        function getConfigFile() {
            const input = document.getElementById('configFileUpload');
            return input.files[0] || null;
        }
        
        // Pre-filter Configuration Functions (PARITY-W2-5)
        
        // Update pre-filter mode
        function updatePreFilterMode() {
            const mode = document.querySelector('input[name="prefilterMode"]:checked').value;
            
            const customPanel = document.getElementById('customSectionsPanel');
            
            if (mode === 'default') {
                customPanel.style.display = 'none';
                updateImpactPreview(['title', 'abstract', 'introduction']);
                
            } else if (mode === 'custom') {
                customPanel.style.display = 'block';
                updateSelectedSections();
                
            } else if (mode === 'full') {
                customPanel.style.display = 'none';
                updateImpactPreview([
                    'title', 'abstract', 'introduction', 'methods', 
                    'results', 'discussion', 'conclusion', 'references'
                ]);
            }
        }
        
        // Update selected sections preview
        function updateSelectedSections() {
            const checkboxes = document.querySelectorAll('.section-checkbox:checked');
            const sections = Array.from(checkboxes).map(cb => cb.value);
            
            document.getElementById('selectedSectionsPreview').textContent = 
                sections.length > 0 ? sections.join(', ') : 'none';
            
            updateImpactPreview(sections);
        }
        
        // Update impact preview (speed/cost estimates)
        function updateImpactPreview(sections) {
            const count = sections.length;
            
            document.getElementById('prefilterSectionCount').textContent = count;
            
            // Speed estimate
            let speed, speedEmoji;
            if (count <= 2) {
                speed = 'Very Fast';
                speedEmoji = '‚ö°‚ö°';
            } else if (count <= 3) {
                speed = 'Fast';
                speedEmoji = '‚ö°';
            } else if (count <= 5) {
                speed = 'Moderate';
                speedEmoji = '‚è±Ô∏è';
            } else {
                speed = 'Slow';
                speedEmoji = 'üêå';
            }
            document.getElementById('prefilterSpeed').textContent = `${speed} ${speedEmoji}`;
            
            // Cost estimate
            let cost, costEmoji;
            if (count <= 2) {
                cost = 'Very Low';
                costEmoji = 'üí∞';
            } else if (count <= 3) {
                cost = 'Low';
                costEmoji = 'üí∞üí∞';
            } else if (count <= 5) {
                cost = 'Moderate';
                costEmoji = 'üí∞üí∞üí∞';
            } else {
                cost = 'High';
                costEmoji = 'üí∞üí∞üí∞üí∞';
            }
            document.getElementById('prefilterCost').textContent = `${cost} ${costEmoji}`;
            
            // Recommendation
            let recommendation;
            if (count === 0) {
                recommendation = '‚ö†Ô∏è Warning: No sections selected! Gap analysis will fail.';
            } else if (count === 1 && sections.includes('abstract')) {
                recommendation = '‚úÖ Great for quick screening or very large datasets (100+ papers).';
            } else if (count >= 1 && count <= 3) {
                recommendation = '‚úÖ Good balance of coverage and efficiency for most reviews.';
            } else if (count >= 4 && count <= 6) {
                recommendation = 'üìä Comprehensive analysis - use for detailed reviews or small datasets.';
            } else {
                recommendation = '‚ö†Ô∏è Full paper analysis is slow and expensive. Consider if necessary.';
            }
            document.getElementById('prefilterRecommendation').textContent = recommendation;
        }
        
        // Apply preset configurations
        function applyPreset(presetName) {
            // Switch to custom mode
            document.getElementById('prefilterCustom').checked = true;
            updatePreFilterMode();
            
            // Uncheck all first
            document.querySelectorAll('.section-checkbox').forEach(cb => cb.checked = false);
            
            // Apply preset
            const presets = {
                'default': ['title', 'abstract', 'introduction'],
                'abstract-only': ['abstract'],
                'methods-focus': ['abstract', 'methods', 'results'],
                'comprehensive': ['title', 'abstract', 'introduction', 'methods', 'results', 'discussion', 'conclusion']
            };
            
            const sections = presets[presetName] || [];
            sections.forEach(section => {
                const checkbox = document.getElementById(`section_${section}`);
                if (checkbox) checkbox.checked = true;
            });
            
            updateSelectedSections();
        }
        
        // Get pre-filter configuration for submission
        function getPreFilterConfig() {
            const mode = document.querySelector('input[name="prefilterMode"]:checked').value;
            
            if (mode === 'default') {
                return null;  // Use pipeline default
            } else if (mode === 'full') {
                return '';  // Empty string = no pre-filter (analyze all)
            } else {
                // Custom: return comma-separated sections
                const checkboxes = document.querySelectorAll('.section-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.value).join(',');
            }
        }
        
        function resetAdvancedOptions() {
            document.getElementById('dryRunMode').checked = false;
            document.getElementById('forceReanalysis').checked = false;
            document.getElementById('forceConfirm').checked = false;
            document.getElementById('forceWarning').style.display = 'none';
            document.getElementById('clearCache').checked = false;
            document.getElementById('budgetLimit').value = '';
            document.getElementById('relevanceThreshold').value = 0.7;
            document.getElementById('relevanceThresholdValue').value = 0.7;
            document.getElementById('enableResumeStage').checked = false;
            document.getElementById('resumeStage').disabled = true;
            document.getElementById('resumeStage').value = '';
            document.getElementById('enableResumeCheckpoint').checked = false;
            document.getElementById('checkpointFilePath').value = '';
            document.getElementById('checkpointInputSection').style.display = 'none';
            document.getElementById('stageProgressDiagram').style.display = 'none';
            document.getElementById('detectedCheckpoints').style.display = 'none';
            document.getElementById('checkpointPreview').style.display = 'none';
            resetStageHighlight();
            document.getElementById('experimentalFeatures').checked = false;
            
            // Reset pre-filter to default (PARITY-W2-5)
            document.getElementById('prefilterDefault').checked = true;
            updatePreFilterMode();
            
            clearConfigUpload();
        }
        
        // Collect advanced options for API request
        function getAdvancedOptions() {
            const resumeConfig = getResumeConfig();
            const inputMethodConfig = getInputMethodConfig();
            
            return {
                dry_run: document.getElementById('dryRunMode').checked,
                force: document.getElementById('forceReanalysis').checked,
                force_confirmed: document.getElementById('forceConfirm').checked,
                clear_cache: document.getElementById('clearCache').checked,
                budget: document.getElementById('budgetLimit').value 
                         ? parseFloat(document.getElementById('budgetLimit').value) 
                         : null,
                relevance_threshold: parseFloat(document.getElementById('relevanceThresholdValue').value),
                resume_from_stage: resumeConfig.resume_from_stage,
                resume_from_checkpoint: resumeConfig.resume_from_checkpoint,
                experimental: document.getElementById('experimentalFeatures').checked,
                pre_filter: getPreFilterConfig(),  // PARITY-W2-5
                ...inputMethodConfig  // PARITY-W3-2: Include input method and data_dir
            };
        }
        
        // Toggle all pillars
        function toggleAllPillars(checkbox) {
            const individual = document.querySelectorAll('.pillar-checkbox-individual');
            individual.forEach(cb => {
                cb.checked = checkbox.checked;
                cb.disabled = checkbox.checked;
            });
        }
        
        // Save configuration and start job
        async function saveConfigAndStart() {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            // Collect selected pillars
            let pillar_selections = [];
            if (document.getElementById('pillar_all').checked) {
                pillar_selections = ['ALL'];
            } else {
                document.querySelectorAll('.pillar-checkbox-individual:checked').forEach(cb => {
                    pillar_selections.push(cb.value);
                });
            }
            
            if (pillar_selections.length === 0) {
                alert('Please select at least one pillar');
                return;
            }
            
            // Get run mode
            const run_mode = document.querySelector('input[name="runMode"]:checked').value;
            
            // Get convergence threshold
            const convergence_threshold = parseFloat(
                document.getElementById('convergenceThreshold').value
            );
            
            // Get output directory configuration
            const output_dir_mode = document.querySelector('input[name="outputDirMode"]:checked').value;
            let output_dir_path = null;
            let overwrite_existing = false;
            
            if (output_dir_mode === 'custom') {
                output_dir_path = document.getElementById('customOutputPath').value;
                if (!output_dir_path) {
                    alert('Please enter a custom output directory path');
                    return;
                }
                overwrite_existing = document.getElementById('overwriteExisting').checked;
            } else if (output_dir_mode === 'existing') {
                output_dir_path = document.getElementById('existingDirDropdown').value;
                if (!output_dir_path) {
                    alert('Please select an existing directory');
                    return;
                }
                // Overwrite is always enabled when using existing directory (backend enforces this)
                overwrite_existing = true;
            }
            
            // Collect advanced options
            const advancedOptions = getAdvancedOptions();
            
            // Validate force options
            if (!validateForceOptions()) {
                return;
            }
            
            const config = {
                pillar_selections,
                run_mode,
                convergence_threshold,
                output_dir_mode,
                output_dir_path,
                overwrite_existing,
                ...advancedOptions
            };
            
            try {
                // Save configuration
                const configResponse = await fetch(`${API_BASE}/api/jobs/${currentJobId}/configure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify(config)
                });
                
                if (!configResponse.ok) {
                    const error = await configResponse.json();
                    throw new Error(error.detail || 'Configuration failed');
                }
                
                // Upload custom config file if selected
                const configFileInput = document.getElementById('configFileUpload');
                if (configFileInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('config_file', configFileInput.files[0]);
                    
                    const uploadResponse = await fetch(`${API_BASE}/api/jobs/${currentJobId}/upload-config`, {
                        method: 'POST',
                        headers: {
                            'X-API-KEY': apiKey
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        console.warn('Failed to upload config file');
                    }
                }
                
                // Start job execution
                const startResponse = await fetch(`${API_BASE}/api/jobs/${currentJobId}/start`, {
                    method: 'POST',
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    throw new Error(error.detail || 'Failed to start job');
                }
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                
                const result = await startResponse.json();
                
                if (config.dry_run) {
                    alert(`Dry run completed for job ${currentJobId}. No API calls were made.\n\nCommand: ${result.command || 'N/A'}`);
                } else {
                    alert(`Job ${currentJobId} started successfully!`);
                }
                
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Download config template with API key authentication
        async function downloadConfigTemplate() {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/config/template`, {
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to download template');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pipeline_config_template.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Failed to download config template: ' + error.message);
            }
        }
        
        // Open configuration modal for existing DRAFT job
        async function configureAndStartJob(jobId, jobName) {
            currentJobId = jobId;
            document.getElementById('configJobId').textContent = jobId;
            document.getElementById('configFileCount').textContent = jobName;
            
            // Load pillar definitions if not already loaded
            await loadPillarDefinitions();
            
            // Show configuration modal
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            modal.show();
        }
        
        // Open new analysis modal without upload requirement
        async function openNewAnalysisModal() {
            // Select Directory Path input method (PARITY-W3-2)
            document.getElementById('inputMethodDirectory').checked = true;
            
            // Trigger the change event to show directory section
            document.getElementById('inputMethodDirectory').dispatchEvent(new Event('change'));
            
            // Scroll to the input method section
            document.querySelector('.card.border-primary').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            
            // Focus the directory path input
            setTimeout(() => {
                document.getElementById('directoryPathInput').focus();
            }, 500);
        }
        
        // Delete a specific job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete job');
                }
                
                alert('Job deleted successfully!');
                // Job list will update via WebSocket
            } catch (error) {
                alert('Failed to delete job: ' + error.message);
            }
        }
        
        // Cancel a running job
        async function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this running job?')) {
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}/cancel`, {
                    method: 'POST',
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to cancel job');
                }
                
                alert('Job cancellation requested!');
            } catch (error) {
                alert('Failed to cancel job: ' + error.message);
            }
        }
        
        // Retry a failed job
        async function retryJob(jobId) {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ force: false })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Retry request failed');
                }
                
                alert('Retry requested successfully!');
            } catch (error) {
                alert('Retry failed: ' + error.message);
            }
        }
        
        // Start all selected jobs
        async function startSelectedJobs() {
            const selectedJobs = Array.from(document.querySelectorAll('.job-checkbox:checked'))
                .map(cb => cb.dataset.jobId);
            
            if (selectedJobs.length === 0) {
                alert('No jobs selected');
                return;
            }
            
            if (!confirm(`Start ${selectedJobs.length} selected job(s)?\n\nNote: Jobs must be in DRAFT or QUEUED status to start.`)) {
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (const jobId of selectedJobs) {
                try {
                    const response = await fetch(`${API_BASE}/api/jobs/${jobId}/start`, {
                        method: 'POST',
                        headers: { 'X-API-KEY': apiKey }
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        const error = await response.json();
                        errorCount++;
                        errors.push(`${jobId.substring(0, 8)}: ${error.detail || 'Unknown error'}`);
                    }
                } catch (error) {
                    errorCount++;
                    errors.push(`${jobId.substring(0, 8)}: ${error.message}`);
                }
            }
            
            let message = `Started ${successCount} job(s) successfully`;
            if (errorCount > 0) {
                message += `\n\nFailed: ${errorCount}\n${errors.join('\n')}`;
            }
            alert(message);
        }
        
        // Delete all selected jobs
        async function deleteSelectedJobs() {
            const selectedJobs = Array.from(document.querySelectorAll('.job-checkbox:checked'))
                .map(cb => cb.dataset.jobId);
            
            if (selectedJobs.length === 0) {
                alert('No jobs selected');
                return;
            }
            
            if (!confirm(`Delete ${selectedJobs.length} selected job(s)? This action cannot be undone.`)) {
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            let successCount = 0;
            let errorCount = 0;
            
            for (const jobId of selectedJobs) {
                try {
                    const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                        method: 'DELETE',
                        headers: { 'X-API-KEY': apiKey }
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }
            
            alert(`Deleted ${successCount} job(s) successfully${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
        }
        
        // Download button handler
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            const currentApiKey = document.getElementById('apiKeyInput').value;
            window.open(`${API_BASE}/api/download/${currentJobId}?X-API-KEY=${currentApiKey}`, '_blank');
        });
        
        // Retry button handler
        document.getElementById('retryBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            const currentApiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${currentJobId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': currentApiKey
                    },
                    body: JSON.stringify({ force: false })
                });
                
                if (!response.ok) throw new Error('Retry request failed');
                
                const result = await response.json();
                alert('Retry requested successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('jobDetailModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Retry error:', error);
                alert('Retry failed: ' + error.message);
            }
        });
        
        // View Job Genealogy
        function viewJobGenealogy() {
            if (!currentJobId) return;
            
            // Open genealogy page in new window
            window.open(`/genealogy?job_id=${currentJobId}`, '_blank');
        }
        
        // Results Viewer Functions
        async function showJobResults(jobId) {
            // Set modal title
            document.getElementById('resultsJobId').textContent = jobId;
            currentJobId = jobId;
            
            // Fetch results list
            const response = await fetch(`${API_BASE}/api/jobs/${jobId}/results`, {
                headers: { 'X-API-KEY': apiKey }
            });
            
            if (!response.ok) {
                alert('Failed to load results');
                return;
            }
            
            const data = await response.json();
            
            // Render file list grouped by category
            renderFileList(data.outputs);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
            modal.show();
        }
        
        function renderFileList(outputs) {
            const fileList = document.getElementById('resultsFileList');
            fileList.innerHTML = '';
            
            // Group by category
            const grouped = {};
            outputs.forEach(file => {
                if (!grouped[file.category]) {
                    grouped[file.category] = [];
                }
                grouped[file.category].push(file);
            });
            
            // Render each category
            const categoryTitles = {
                'pillar_waterfalls': 'üìä Pillar Waterfalls',
                'visualizations': 'üìà Visualizations',
                'reports': 'üìÑ Reports',
                'data': 'üíæ Data Files',
                'other': 'üì¶ Other'
            };
            
            for (const [category, files] of Object.entries(grouped)) {
                // Category header
                const header = document.createElement('div');
                header.className = 'list-group-item bg-light fw-bold';
                header.textContent = categoryTitles[category] || category;
                fileList.appendChild(header);
                
                // Files in category
                files.forEach(file => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-truncate" style="font-size: 0.85rem;">${file.filename}</span>
                            <span class="badge bg-secondary">${formatFileSize(file.size)}</span>
                        </div>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        viewFile(file);
                    };
                    fileList.appendChild(item);
                });
            }
        }
        
        async function viewFile(file) {
            const viewer = document.getElementById('resultsViewer');
            
            // Show loading
            viewer.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            
            const fileUrl = `${API_BASE}/api/jobs/${currentJobId}/results/${file.path}`;
            
            try {
                if (file.mime_type === 'text/html' || file.filename.endsWith('.html')) {
                    // Render HTML in iframe
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <iframe 
                            src="${fileUrl}" 
                            style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 5px;">
                        </iframe>
                    `;
                } else if (file.mime_type === 'application/json' || file.filename.endsWith('.json')) {
                    // Fetch and pretty-print JSON
                    const response = await fetch(fileUrl);
                    const jsonData = await response.json();
                    
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <pre class="bg-dark text-light p-3" style="max-height: 600px; overflow-y: auto; border-radius: 5px;"><code>${JSON.stringify(jsonData, null, 2)}</code></pre>
                    `;
                } else if (file.mime_type?.startsWith('text/') || file.filename.endsWith('.md')) {
                    // Fetch and display text/markdown
                    const response = await fetch(fileUrl);
                    const textData = await response.text();
                    
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <pre class="bg-light p-3" style="max-height: 600px; overflow-y: auto; border-radius: 5px;"><code>${escapeHtml(textData)}</code></pre>
                    `;
                } else {
                    // Download-only for binary files
                    viewer.innerHTML = `
                        <div class="text-center p-5">
                            <h5>${file.filename}</h5>
                            <p class="text-muted">Preview not available for this file type</p>
                            <a href="${fileUrl}" class="btn btn-primary" download>
                                üíæ Download File
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                viewer.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load file: ${error.message}
                    </div>
                `;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function downloadAllResults() {
            window.open(`${API_BASE}/api/jobs/${currentJobId}/results/download/all`, '_blank');
        }
        
        // === INTERACTIVE PROMPTS ===
        let currentPromptId = null;
        let promptTimeoutInterval = null;
        
        function showPrompt(promptData) {
            currentPromptId = promptData.prompt_id;
            
            // Set job ID
            document.getElementById('promptJobId').textContent = promptData.job_id;
            
            // Set message
            document.getElementById('promptMessage').textContent = promptData.prompt_data.message;
            
            // Render prompt content based on type
            const content = document.getElementById('promptContent');
            
            switch (promptData.prompt_type) {
                case 'pillar_selection':
                    content.innerHTML = renderPillarSelectionPrompt(promptData.prompt_data);
                    break;
                case 'run_mode':
                    content.innerHTML = renderRunModePrompt(promptData.prompt_data);
                    break;
                case 'continue':
                    content.innerHTML = renderContinuePrompt(promptData.prompt_data);
                    break;
                default:
                    content.innerHTML = '<p>Unknown prompt type</p>';
            }
            
            // Start timeout countdown
            startTimeoutCountdown(300); // 5 minutes
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('promptModal'));
            modal.show();
        }
        
        function renderPillarSelectionPrompt(promptData) {
            const pillars = promptData.options || [];
            
            let html = '<div class="mb-3">';
            
            if (promptData.allow_all) {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="ALL" id="choice_all">
                        <label class="form-check-label" for="choice_all">
                            <strong>ALL</strong> - Analyze all pillars (single pass)
                        </label>
                    </div>
                `;
            }
            
            if (promptData.allow_deep) {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="DEEP" id="choice_deep">
                        <label class="form-check-label" for="choice_deep">
                            <strong>DEEP</strong> - Run iterative deep-review loop
                        </label>
                    </div>
                `;
            }
            
            html += '<hr>';
            
            pillars.forEach((pillar, index) => {
                const pillarName = pillar.split(':')[0];
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="${index + 1}" id="choice_${index}">
                        <label class="form-check-label" for="choice_${index}">
                            ${index + 1}. ${pillarName}
                        </label>
                    </div>
                `;
            });
            
            if (promptData.allow_none) {
                html += `
                    <hr>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="NONE" id="choice_none">
                        <label class="form-check-label" for="choice_none">
                            <strong>NONE</strong> - Cancel analysis
                        </label>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function renderRunModePrompt(promptData) {
            return `
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="ONCE" id="mode_once" checked>
                        <label class="form-check-label" for="mode_once">
                            <strong>ONCE</strong> - Single pass analysis
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="DEEP_LOOP" id="mode_deep_loop">
                        <label class="form-check-label" for="mode_deep_loop">
                            <strong>DEEP_LOOP</strong> - Iterative analysis until convergence
                        </label>
                    </div>
                </div>
            `;
        }
        
        function renderContinuePrompt(promptData) {
            return `
                <p>${promptData.details || 'Continue?'}</p>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="yes" id="continue_yes" checked>
                        <label class="form-check-label" for="continue_yes">
                            Yes, continue
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="no" id="continue_no">
                        <label class="form-check-label" for="continue_no">
                            No, stop here
                        </label>
                    </div>
                </div>
            `;
        }
        
        function startTimeoutCountdown(seconds) {
            const display = document.getElementById('promptTimeout');
            let remaining = seconds;
            
            if (promptTimeoutInterval) {
                clearInterval(promptTimeoutInterval);
            }
            
            promptTimeoutInterval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(promptTimeoutInterval);
                    alert('Prompt timed out. Job will be cancelled.');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                    if (modal) modal.hide();
                }
                
                remaining--;
            }, 1000);
        }
        
        async function submitPromptResponse() {
            const selected = document.querySelector('input[name="promptChoice"]:checked');
            
            if (!selected) {
                alert('Please select an option');
                return;
            }
            
            const response = selected.value;
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const result = await fetch(`${API_BASE}/api/prompts/${currentPromptId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ response })
                });
                
                if (!result.ok) {
                    const errorData = await result.json();
                    throw new Error(errorData.detail || 'Failed to submit response');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                if (modal) modal.hide();
                
                // Clear timeout
                if (promptTimeoutInterval) {
                    clearInterval(promptTimeoutInterval);
                }
                
                // Show notification
                console.log('Response submitted. Job will continue.');
                
            } catch (error) {
                alert('Failed to submit response: ' + error.message);
            }
        }
        
        function cancelPrompt() {
            // Submit "NONE" as cancellation response
            const noneRadio = document.querySelector('input[name="promptChoice"][value="NONE"]');
            if (noneRadio) {
                noneRadio.checked = true;
                submitPromptResponse();
            } else {
                // If no NONE option, just close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                if (modal) modal.hide();
                if (promptTimeoutInterval) {
                    clearInterval(promptTimeoutInterval);
                }
            }
        }
        
        // === OUTPUT DIRECTORY CONFIGURATION ===
        
        // Toggle visibility based on mode selection
        document.querySelectorAll('input[name="outputDirMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('customPathSection').style.display = 
                    (e.target.value === 'custom') ? 'block' : 'none';
                document.getElementById('existingDirSection').style.display = 
                    (e.target.value === 'existing') ? 'block' : 'none';
                
                // Load existing directories when "existing" mode is selected
                if (e.target.value === 'existing') {
                    refreshOutputDirectoryList();
                }
            });
        });
        
        // Refresh existing directory dropdown
        async function refreshOutputDirectoryList() {
            const dropdown = document.getElementById('existingDirDropdown');
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/scan-output-directories`, {
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to scan directories');
                }
                
                const data = await response.json();
                
                dropdown.innerHTML = '<option value="">-- Select a directory --</option>';
                
                if (data.directories && data.directories.length > 0) {
                    data.directories.forEach(dir => {
                        const option = document.createElement('option');
                        option.value = dir.path;
                        const lastModified = new Date(dir.last_modified).toLocaleDateString();
                        option.textContent = `${dir.path} (${dir.file_count} files, ${lastModified})`;
                        dropdown.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No existing output directories found';
                    option.disabled = true;
                    dropdown.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to refresh directory list:', error);
                alert('Failed to load existing directories: ' + error.message);
            }
        }
        
        // === DIRECTORY STATE ANALYSIS (PARITY-W1-3) ===
        
        // Analyze directory when path changes
        async function analyzeOutputDirectory(directoryPath) {
            if (!directoryPath) {
                // Hide indicator if no path
                document.getElementById('directoryStateIndicator').style.display = 'none';
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/upload/analyze-directory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ directory_path: directoryPath })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to analyze directory');
                }
                
                const data = await response.json();
                displayDirectoryState(data);
                
            } catch (error) {
                console.error('Failed to analyze directory:', error);
                // Don't show error to user - just hide indicator
                document.getElementById('directoryStateIndicator').style.display = 'none';
            }
        }
        
        function displayDirectoryState(data) {
            const indicator = document.getElementById('directoryStateIndicator');
            const stateIcon = document.getElementById('stateIcon');
            const stateDescription = document.getElementById('stateDescription');
            const recommendedMode = document.getElementById('recommendedMode');
            const recommendationReason = document.getElementById('recommendationReason');
            
            // Set state icon and color
            const stateConfig = {
                'not_exist': { icon: 'üìÅ', color: 'primary', text: 'New Directory' },
                'empty': { icon: 'üìÇ', color: 'info', text: 'Empty Directory' },
                'has_csv': { icon: 'üìÑ', color: 'warning', text: 'Contains CSV Files' },
                'has_results': { icon: '‚úÖ', color: 'success', text: 'Has Previous Results' }
            };
            
            const config = stateConfig[data.state.state] || stateConfig['empty'];
            
            stateIcon.textContent = config.icon;
            indicator.className = `alert alert-${config.color} mt-3`;
            stateDescription.innerHTML = `
                <strong>${config.text}</strong><br>
                Files: ${data.state.file_count}<br>
                ${data.state.has_gap_report ? '‚úÖ Has analysis report' : '‚ùå No analysis report'}
            `;
            
            // Set recommendation
            recommendedMode.textContent = data.recommendation.mode.toUpperCase();
            recommendedMode.className = `badge bg-${data.recommendation.mode === 'baseline' ? 'primary' : 'success'}`;
            recommendationReason.textContent = data.recommendation.reason;
            
            // Show indicator
            indicator.style.display = 'block';
            
            // Note: Mode selection is handled by "Accept Recommendation" button
            // We don't auto-select to avoid confusion
        }
        
        // Accept recommendation button
        document.getElementById('acceptRecommendation').addEventListener('click', () => {
            // Mode already set by auto-selection in displayDirectoryState
            // Just scroll to upload form to continue workflow
            document.getElementById('uploadForm').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Change mode button
        document.getElementById('changeMode').addEventListener('click', () => {
            // Scroll to configuration section
            document.getElementById('configureSection').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Trigger analysis when custom path entered
        document.getElementById('customOutputPath').addEventListener('blur', (e) => {
            analyzeOutputDirectory(e.target.value);
        });
        
        // Also trigger on Enter key
        document.getElementById('customOutputPath').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                analyzeOutputDirectory(e.target.value);
            }
        });
        
        // Trigger analysis when existing directory selected
        document.getElementById('existingDirDropdown').addEventListener('change', (e) => {
            analyzeOutputDirectory(e.target.value);
        });
        
        // === UPLOAD MODE SWITCHING ===
        document.querySelectorAll('input[name="uploadMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                const fileSection = document.getElementById('fileUploadSection');
                const folderSection = document.getElementById('folderUploadSection');
                
                if (mode === 'files') {
                    fileSection.style.display = 'block';
                    folderSection.style.display = 'none';
                    document.getElementById('batchFileInput').required = true;
                    document.getElementById('folderInput').required = false;
                } else {
                    fileSection.style.display = 'none';
                    folderSection.style.display = 'block';
                    document.getElementById('batchFileInput').required = false;
                    document.getElementById('folderInput').required = true;
                }
            });
        });
        
        // === INPUT METHOD SWITCHING (PARITY-W3-2) ===
        // Store scan results globally
        let directoryScanResults = null;
        let fileListSortColumn = 'filename';
        let fileListSortAscending = true;
        
        // Input method switching
        document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const method = e.target.value;
                const uploadSection = document.getElementById('uploadMethodSection');
                const directorySection = document.getElementById('directoryMethodSection');
                
                if (method === 'upload') {
                    uploadSection.style.display = 'block';
                    directorySection.style.display = 'none';
                    document.getElementById('batchFileInput').required = true;
                } else {
                    uploadSection.style.display = 'none';
                    directorySection.style.display = 'block';
                    document.getElementById('batchFileInput').required = false;
                }
            });
        });
        
        // Scan directory function
        async function scanDirectory() {
            const pathInput = document.getElementById('directoryPathInput');
            const scanBtn = document.getElementById('scanDirectoryBtn');
            const resultsDiv = document.getElementById('directoryScanResults');
            const errorDiv = document.getElementById('directoryScanError');
            const apiKey = document.getElementById('apiKeyInput').value;
            
            const path = pathInput.value.trim();
            
            if (!path) {
                // Show inline error instead of alert
                document.getElementById('scanErrorMessage').textContent = 'Please enter a directory path';
                errorDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                pathInput.focus();
                return;
            }
            
            // Reset UI
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanning...';
            
            try {
                const response = await fetch(`${API_BASE}/api/directory/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        path: path,
                        recursive: document.getElementById('scanRecursive').checked,
                        follow_symlinks: document.getElementById('followSymlinks').checked
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Scan failed');
                }
                
                const data = await response.json();
                directoryScanResults = data;
                
                // Update UI with results
                document.getElementById('scanPdfCount').textContent = data.pdf_count;
                document.getElementById('scanCsvCount').textContent = data.csv_count;
                document.getElementById('scanTotalSize').textContent = formatFileSize(data.total_size_bytes);
                document.getElementById('scanSubdirCount').textContent = data.subdirectory_count;
                
                resultsDiv.style.display = 'block';
                
            } catch (error) {
                document.getElementById('scanErrorMessage').textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'üîç Scan';
            }
        }
        
        // Show file list modal
        function showFileListModal() {
            if (!directoryScanResults || !directoryScanResults.files) {
                // Show inline error instead of alert
                const errorDiv = document.getElementById('directoryScanError');
                document.getElementById('scanErrorMessage').textContent = 'No scan results available. Please scan a directory first.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Update summary
            document.getElementById('fileListPdfCount').textContent = directoryScanResults.pdf_count;
            document.getElementById('fileListCsvCount').textContent = directoryScanResults.csv_count;
            document.getElementById('fileListTotalSize').textContent = formatFileSize(directoryScanResults.total_size_bytes);
            
            // Clear search
            document.getElementById('fileListSearch').value = '';
            
            // Render file list
            renderFileListTable(directoryScanResults.files);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('fileListModal'));
            modal.show();
        }
        
        // Render file list table
        function renderFileListTable(files) {
            const tbody = document.getElementById('fileListBody');
            tbody.innerHTML = '';
            
            files.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${file.filename}">${truncateString(file.filename, 40)}</td>
                    <td><span class="badge ${file.type === 'pdf' ? 'bg-primary' : 'bg-success'}">${file.type.toUpperCase()}</span></td>
                    <td>${formatFileSize(file.size_bytes)}</td>
                    <td title="${file.relative_path}" class="text-muted small">${truncateString(file.relative_path, 50)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Filter file list
        function filterFileList() {
            if (!directoryScanResults || !directoryScanResults.files) return;
            
            const searchTerm = document.getElementById('fileListSearch').value.toLowerCase();
            const filtered = directoryScanResults.files.filter(file => 
                file.filename.toLowerCase().includes(searchTerm) ||
                file.relative_path.toLowerCase().includes(searchTerm)
            );
            
            renderFileListTable(filtered);
        }
        
        // Sort file list
        function sortFileList(column) {
            if (!directoryScanResults || !directoryScanResults.files) return;
            
            if (fileListSortColumn === column) {
                fileListSortAscending = !fileListSortAscending;
            } else {
                fileListSortColumn = column;
                fileListSortAscending = true;
            }
            
            const files = [...directoryScanResults.files];
            
            files.sort((a, b) => {
                let valA, valB;
                
                switch (column) {
                    case 'filename':
                        valA = a.filename.toLowerCase();
                        valB = b.filename.toLowerCase();
                        break;
                    case 'type':
                        valA = a.type;
                        valB = b.type;
                        break;
                    case 'size':
                        valA = a.size_bytes;
                        valB = b.size_bytes;
                        break;
                    case 'path':
                        valA = a.relative_path.toLowerCase();
                        valB = b.relative_path.toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (valA < valB) return fileListSortAscending ? -1 : 1;
                if (valA > valB) return fileListSortAscending ? 1 : -1;
                return 0;
            });
            
            renderFileListTable(files);
        }
        
        // Helper: truncate string
        function truncateString(str, maxLength) {
            if (str.length <= maxLength) return str;
            return str.substring(0, maxLength - 3) + '...';
        }
        
        // Get input method and data for job submission
        function getInputMethodConfig() {
            const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
            
            if (inputMethod === 'directory') {
                if (!directoryScanResults) {
                    throw new Error('Please scan a directory before proceeding');
                }
                return {
                    input_method: 'directory',
                    data_dir: directoryScanResults.path,
                    scan_recursive: document.getElementById('scanRecursive').checked,
                    follow_symlinks: document.getElementById('followSymlinks').checked
                };
            }
            
            return {
                input_method: 'upload'
            };
        }
        
        // Import Results Form Handler
        document.getElementById('importResultsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dirSelect = document.getElementById('importDirSelect');
            const resultsDir = dirSelect.value;
            const jobName = document.getElementById('importNameInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value;
            
            if (!resultsDir) {
                alert('Please select a results directory');
                return;
            }
            
            console.log('Import request:', { resultsDir, jobName });
            
            const statusDiv = document.getElementById('importStatus');
            const messageSpan = document.getElementById('importMessage');
            
            statusDiv.style.display = 'block';
            messageSpan.textContent = 'Importing results...';
            
            try {
                const response = await fetch(`${API_BASE}/api/import-results`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        results_dir: resultsDir,
                        job_name: jobName || null
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || 'Import failed');
                }
                
                const result = await response.json();
                
                messageSpan.textContent = result.message;
                statusDiv.querySelector('.alert').className = 'alert alert-success';
                
                // Reset form
                document.getElementById('importResultsForm').reset();
                document.getElementById('importNameInput').value = '';
                
                // Hide status after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('Import error:', error);
                // Handle different error types
                let errorMessage = 'Import failed';
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error.detail) {
                    errorMessage = error.detail;
                }
                messageSpan.textContent = `Import failed: ${errorMessage}`;
                statusDiv.querySelector('.alert').className = 'alert alert-danger';
            }
        });
        
        // Handle folder input file count display
        document.getElementById('folderInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const pdfFiles = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
            
            if (pdfFiles.length === 0) {
                alert('No PDF files found in selected folder');
            } else {
                console.log(`Found ${pdfFiles.length} PDF files in folder`);
            }
        });
        
        // === RESULTS BROWSER ===
        async function openResultsBrowser() {
            const modal = new bootstrap.Modal(document.getElementById('resultsBrowserModal'));
            modal.show();
            await loadAllResults();
        }
        
        async function loadAllResults() {
            const listContainer = document.getElementById('allResultsList');
            listContainer.innerHTML = '<div class="text-center text-muted p-4">Loading results...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs`, {
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load results');
                }
                
                const data = await response.json();
                window.allJobsCache = data.jobs; // Cache for filtering
                renderAllResults(data.jobs);
            } catch (error) {
                listContainer.innerHTML = `<div class="alert alert-danger">Failed to load results: ${error.message}</div>`;
            }
        }
        
        function renderAllResults(allJobs) {
            const listContainer = document.getElementById('allResultsList');
            const searchInput = document.getElementById('resultsSearchInput');
            const filterSelect = document.getElementById('resultsFilterSelect');
            
            let filteredJobs = allJobs;
            const searchTerm = (searchInput?.value || '').toLowerCase();
            const filterType = filterSelect?.value || 'all';
            
            if (searchTerm) {
                filteredJobs = filteredJobs.filter(job => 
                    (job.id || '').toLowerCase().includes(searchTerm) ||
                    (job.filename || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (filterType !== 'all') {
                if (filterType === 'dashboard') {
                    filteredJobs = filteredJobs.filter(job => job.source !== 'import');
                } else if (filterType === 'imported') {
                    filteredJobs = filteredJobs.filter(job => job.source === 'import');
                } else if (filterType === 'completed') {
                    filteredJobs = filteredJobs.filter(job => job.status === 'completed' || job.status === 'imported');
                }
            }
            
            if (filteredJobs.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-muted p-4">No results found</div>';
                return;
            }
            
            listContainer.innerHTML = filteredJobs.map(job => {
                const sourceBadge = job.source === 'import' 
                    ? '<span class="badge bg-success">Imported</span>'
                    : '<span class="badge bg-primary">Dashboard</span>';
                const statusBadge = getStatusBadge(job.status);
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6><code>${job.id.substring(0, 12)}</code> - ${job.filename || 'Unknown'}</h6>
                                <small class="text-muted">Created: ${formatDateTime(job.created_at)}</small>
                                <div class="mt-2">${sourceBadge} ${statusBadge}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="showJobDetail('${job.id}')">View</button>
                                ${(job.status === 'completed' || job.status === 'imported') ? 
                                    `<button class="btn btn-sm btn-outline-success" onclick="showJobResults('${job.id}')">Results</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function refreshResultsBrowser() {
            await loadAllResults();
        }
        
        // Load available import directories
        async function loadImportDirectories() {
            const select = document.getElementById('importDirSelect');
            if (!select) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/scan-import-directories`, {
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load directories');
                }
                
                const data = await response.json();
                
                if (data.directories.length === 0) {
                    select.innerHTML = '<option value="">No importable directories found</option>';
                } else {
                    select.innerHTML = '<option value="">-- Select a directory --</option>' +
                        data.directories.map(dir => 
                            `<option value="${dir.path}">${dir.name} (${dir.file_count} files)</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Failed to load import directories:', error);
                select.innerHTML = '<option value="">Error loading directories</option>';
            }
        }
        
        // Initialize
        connectWebSocket();
        loadPillarDefinitions();
        loadImportDirectories();
        
        // Load available directories for import
        const resultsSearchInput = document.getElementById('resultsSearchInput');
        const resultsFilterSelect = document.getElementById('resultsFilterSelect');
        
        if (resultsSearchInput) {
            resultsSearchInput.addEventListener('input', () => {
                const jobs = window.allJobsCache || [];
                renderAllResults(jobs);
            });
        }
        
        if (resultsFilterSelect) {
            resultsFilterSelect.addEventListener('change', () => {
                const jobs = window.allJobsCache || [];
                renderAllResults(jobs);
            });
        }
    </script>
    
    <!-- Continuation Mode JavaScript -->
    <script src="/static/js/continuation.js"></script>
    
    <!-- Resource Monitor JavaScript -->
    <script src="/static/js/resource_monitor.js"></script>
    
    <!-- Bulk Operations JavaScript -->
    <script src="/static/js/bulk_operations.js"></script>
</body>
</html>
