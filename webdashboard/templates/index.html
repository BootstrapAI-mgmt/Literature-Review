<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literature Review Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            padding-top: 20px;
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.35rem 0.65rem;
        }
        .job-row {
            cursor: pointer;
        }
        .job-row:hover {
            background-color: #f8f9fa;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #uploadProgress {
            display: none;
        }
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        /* Enhanced Outputs Section */
        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            margin-top: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .enhanced-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .enhanced-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .enhanced-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .enhanced-card .card-icon {
            font-size: 1.3em;
        }

        .enhanced-card h4 {
            margin: 0;
            font-size: 1em;
        }

        .enhanced-card .card-body {
            padding: 15px;
        }

        /* Proof Scorecard Styles */
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            border: 6px solid;
        }

        .score-circle.score-high {
            border-color: #28a745;
            color: #28a745;
        }

        .score-circle.score-medium {
            border-color: #ffc107;
            color: #ffc107;
        }

        .score-circle.score-low {
            border-color: #dc3545;
            color: #dc3545;
        }

        .score-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .score-label {
            font-size: 0.75em;
            text-transform: uppercase;
        }

        .verdict-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin: 8px 0;
            font-size: 0.85em;
        }

        .verdict-strong { background: #d4edda; color: #155724; }
        .verdict-moderate { background: #fff3cd; color: #856404; }
        .verdict-weak { background: #f8d7da; color: #721c24; }
        .verdict-insufficient { background: #f8d7da; color: #721c24; }

        .headline {
            font-style: italic;
            color: #666;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .next-steps {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .next-steps ul {
            margin: 5px 0 0 0;
            padding-left: 18px;
        }

        .next-steps li {
            margin: 4px 0;
            font-size: 0.85em;
        }

        /* Cost Summary Styles */
        .cost-metrics {
            margin: 15px 0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
            font-size: 0.9em;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1em;
        }

        .metric-value.cost-total {
            color: #667eea;
            font-size: 1.3em;
        }

        .metric-value.savings {
            color: #28a745;
        }

        .progress-bar-container {
            position: relative;
            width: 130px;
            height: 22px;
            background: #e9ecef;
            border-radius: 11px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 11px;
        }

        .progress-bar.budget-low {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }

        .progress-bar.budget-medium {
            background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
        }

        .progress-bar.budget-high {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #333;
        }

        /* Sufficiency Matrix Styles */
        .quadrant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 15px 0;
        }

        .quadrant {
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .quadrant.q1 {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
        }

        .quadrant.q2 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
        }

        .quadrant.q3 {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
        }

        .quadrant.q4 {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 2px solid #17a2b8;
        }

        .quadrant-name {
            font-weight: 600;
            font-size: 0.75em;
            margin-bottom: 6px;
        }

        .quadrant-count {
            font-size: 1.6em;
            font-weight: bold;
        }

        .recommendations {
            margin-top: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .recommendations ul {
            margin: 5px 0 0 0;
            padding-left: 18px;
        }

        .recommendations li {
            margin: 4px 0;
            font-size: 0.85em;
        }

        /* Button Styles */
        .btn-full-report {
            display: block;
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-full-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .enhanced-cards-grid {
                grid-template-columns: 1fr;
            }
            
            .quadrant-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Progress Monitoring Styles */
        .stage-item {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #dee2e6;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .stage-item.active {
            border-left-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .stage-item.complete {
            border-left-color: #198754;
            background: #d1e7dd;
        }
        
        .stage-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .iteration-counter {
            font-size: 0.875rem;
            color: #6c757d;
            margin-left: 8px;
        }
        
        .log-viewer-live {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-line {
            margin: 2px 0;
        }
        
        .log-line.error {
            color: #f48771;
        }
        
        .log-line.warning {
            color: #dcdcaa;
        }
        
        .log-line.success {
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status">
        <span class="badge bg-secondary" id="wsStatus">Connecting...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-4">üìö Literature Review Dashboard</h1>
                <p class="lead">Monitor and manage pipeline jobs</p>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Total Jobs</h5>
                        <h2 class="display-4" id="totalJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">Completed</h5>
                        <h2 class="display-4" id="completedJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Running</h5>
                        <h2 class="display-4" id="runningJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-danger">Failed</h5>
                        <h2 class="display-4" id="failedJobs">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üì§ Upload Research Papers</h5>
                    </div>
                    <div class="card-body">
                        <form id="batchUploadForm">
                            <div class="mb-3">
                                <label for="batchFileInput" class="form-label">
                                    Select PDF files (multiple allowed)
                                </label>
                                <input 
                                    class="form-control" 
                                    type="file" 
                                    id="batchFileInput" 
                                    accept=".pdf" 
                                    multiple
                                    required>
                                <div class="form-text">
                                    Select one or more research papers (PDF format only)
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="apiKeyInput" class="form-label">API Key</label>
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="apiKeyInput" 
                                    value="dev-key-change-in-production">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                üì§ Upload Papers
                            </button>
                        </form>
                        
                        <div class="progress mt-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Uploading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìã Jobs</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No jobs yet. Upload a PDF to get started.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <!-- Job Info -->
                        <div class="alert alert-info">
                            <strong>Job ID:</strong> <span id="configJobId"></span><br>
                            <strong>Files:</strong> <span id="configFileCount"></span> PDFs uploaded
                        </div>
                        
                        <!-- Pillar Selection -->
                        <div class="mb-4">
                            <h6>Select Pillars to Analyze</h6>
                            <div class="form-check">
                                <input 
                                    class="form-check-input pillar-checkbox" 
                                    type="checkbox" 
                                    value="ALL" 
                                    id="pillar_all"
                                    onchange="toggleAllPillars(this)">
                                <label class="form-check-label" for="pillar_all">
                                    <strong>All Pillars</strong> (Comprehensive Analysis)
                                </label>
                            </div>
                            <hr>
                            <div id="pillarCheckboxes">
                                <!-- Populated dynamically from pillar_definitions.json -->
                            </div>
                        </div>
                        
                        <!-- Run Mode Selection -->
                        <div class="mb-4">
                            <h6>Analysis Mode</h6>
                            <div class="form-check">
                                <input 
                                    class="form-check-input" 
                                    type="radio" 
                                    name="runMode" 
                                    value="ONCE" 
                                    id="mode_once"
                                    checked>
                                <label class="form-check-label" for="mode_once">
                                    <strong>Single Pass</strong> - Quick analysis (faster)
                                </label>
                                <div class="form-text ms-4">
                                    Runs analysis once without iterative refinement.
                                    Recommended for initial exploration.
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input 
                                    class="form-check-input" 
                                    type="radio" 
                                    name="runMode" 
                                    value="DEEP_LOOP" 
                                    id="mode_deep">
                                <label class="form-check-label" for="mode_deep">
                                    <strong>Deep Iterative Loop</strong> - Comprehensive (slower)
                                </label>
                                <div class="form-text ms-4">
                                    Runs Deep Reviewer iteratively until convergence (¬±5%).
                                    Provides most thorough gap analysis.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Options (Optional) -->
                        <div class="mb-3">
                            <button 
                                class="btn btn-sm btn-outline-secondary" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#advancedOptions">
                                ‚öôÔ∏è Advanced Options
                            </button>
                            <div class="collapse mt-2" id="advancedOptions">
                                <div class="card card-body">
                                    <div class="mb-2">
                                        <label class="form-label">Convergence Threshold (%)</label>
                                        <input 
                                            type="number" 
                                            class="form-control" 
                                            id="convergenceThreshold"
                                            value="5.0"
                                            min="0.1"
                                            max="20"
                                            step="0.1">
                                        <div class="form-text">
                                            Stop iterating when changes are below this threshold
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveConfigAndStart()">
                        üöÄ Save & Start Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal fade" id="jobDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Job ID:</strong>
                            <p id="detailJobId" class="font-monospace"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            <p id="detailStatus"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Filename:</strong>
                            <p id="detailFilename"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong>
                            <p id="detailCreated"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="errorSection" style="display: none;">
                        <strong>Error:</strong>
                        <div class="alert alert-danger" id="detailError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Logs:</strong>
                        <div class="log-viewer" id="detailLogs">
                            Loading logs...
                        </div>
                    </div>
                    
                    <!-- Real-time Progress Display -->
                    <div class="mb-3" id="progressContainer" style="display: none;">
                        <h6>Pipeline Progress</h6>
                        
                        <!-- Overall Progress Bar -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Overall Completion</span>
                                <span id="progressPercentage">0%</span>
                            </div>
                            <div class="progress">
                                <div 
                                    class="progress-bar progress-bar-striped progress-bar-animated" 
                                    id="progressBar"
                                    role="progressbar" 
                                    style="width: 0%">
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-1">
                                <small class="text-muted" id="etaDisplay">ETA: calculating...</small>
                            </div>
                        </div>
                        
                        <!-- Stage Indicators -->
                        <div class="mb-3">
                            <h6 class="small">Pipeline Stages</h6>
                            <div id="stageIndicators">
                                <div class="stage-item" data-stage="initialization">
                                    <span class="badge bg-secondary">‚è∏</span> Initialization
                                </div>
                                <div class="stage-item" data-stage="judge">
                                    <span class="badge bg-secondary">‚è∏</span> Judge Validation
                                </div>
                                <div class="stage-item" data-stage="deep_review">
                                    <span class="badge bg-secondary">‚è∏</span> Deep Review
                                    <span class="iteration-counter" style="display: none;"></span>
                                </div>
                                <div class="stage-item" data-stage="gap_analysis">
                                    <span class="badge bg-secondary">‚è∏</span> Gap Analysis
                                    <span class="iteration-counter" style="display: none;"></span>
                                </div>
                                <div class="stage-item" data-stage="visualization">
                                    <span class="badge bg-secondary">‚è∏</span> Visualization
                                </div>
                                <div class="stage-item" data-stage="finalization">
                                    <span class="badge bg-secondary">‚è∏</span> Finalization
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Logs -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="small mb-0">Live Logs</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                                        Clear
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleAutoScroll()">
                                        <span id="autoScrollIcon">üîí</span> Auto-scroll
                                    </button>
                                </div>
                            </div>
                            <div class="log-viewer-live" id="liveLogViewer">
                                <div class="text-muted text-center p-3">
                                    Waiting for logs...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legacy Progress Section (kept for backward compatibility) -->
                    <div class="mb-3" id="progressSection" style="display: none;">
                        <strong>Progress:</strong>
                        <div id="detailProgress"></div>
                    </div>
                    
                    <!-- Enhanced Analytical Outputs Section -->
                    <div id="enhancedOutputsSection" style="display: none;">
                        <h5 class="section-title">üìä Enhanced Analysis</h5>
                        
                        <div class="enhanced-cards-grid">
                            
                            <!-- Proof Scorecard Card -->
                            <div id="proofScorecardCard" style="display: none;" class="enhanced-card proof-scorecard-card">
                                <div class="card-header">
                                    <span class="card-icon">üéØ</span>
                                    <h4>Proof Completeness Scorecard</h4>
                                </div>
                                <div class="card-body">
                                    <div id="scoreCircle" class="score-circle">
                                        <div class="score-value" id="scoreValue">0%</div>
                                        <div class="score-label">Ready</div>
                                    </div>
                                    <div id="verdictBadge" class="verdict-badge">
                                        UNKNOWN
                                    </div>
                                    <p class="headline" id="scoreHeadline"></p>
                                    
                                    <div class="next-steps" id="nextStepsSection" style="display: none;">
                                        <strong>Top Priorities:</strong>
                                        <ul id="nextStepsList">
                                        </ul>
                                    </div>
                                    
                                    <a id="proofReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üìÑ View Full Report
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Cost Summary Card -->
                            <div id="costSummaryCard" style="display: none;" class="enhanced-card cost-summary-card">
                                <div class="card-header">
                                    <span class="card-icon">üí∞</span>
                                    <h4>API Cost Summary</h4>
                                </div>
                                <div class="card-body">
                                    <div class="cost-metrics">
                                        <div class="metric-row">
                                            <span class="metric-label">Total Cost:</span>
                                            <span class="metric-value cost-total" id="totalCost">
                                                $0.00
                                            </span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Per Paper:</span>
                                            <span class="metric-value" id="perPaperCost">
                                                $0.00
                                            </span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Budget Used:</span>
                                            <span class="metric-value">
                                                <div class="progress-bar-container">
                                                    <div class="progress-bar" id="budgetBar" style="width: 0%">
                                                    </div>
                                                    <span class="progress-text" id="budgetPercent">
                                                        0.0%
                                                    </span>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="metric-row" id="cacheSavingsRow" style="display: none;">
                                            <span class="metric-label">Cache Savings:</span>
                                            <span class="metric-value savings" id="cacheSavings">
                                                -$0.00
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <a id="costReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üìä View Breakdown
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Sufficiency Matrix Card -->
                            <div id="sufficiencyCard" style="display: none;" class="enhanced-card sufficiency-card">
                                <div class="card-header">
                                    <span class="card-icon">üìà</span>
                                    <h4>Evidence Sufficiency Matrix</h4>
                                </div>
                                <div class="card-body">
                                    <div class="quadrant-grid">
                                        <div class="quadrant q1" id="quadrantQ1" style="display: none;">
                                            <div class="quadrant-name">Strong Foundation</div>
                                            <div class="quadrant-count" id="countQ1">0</div>
                                        </div>
                                        <div class="quadrant q2" id="quadrantQ2" style="display: none;">
                                            <div class="quadrant-name">Promising Seeds</div>
                                            <div class="quadrant-count" id="countQ2">0</div>
                                        </div>
                                        <div class="quadrant q3" id="quadrantQ3" style="display: none;">
                                            <div class="quadrant-name">Hollow Coverage</div>
                                            <div class="quadrant-count" id="countQ3">0</div>
                                        </div>
                                        <div class="quadrant q4" id="quadrantQ4" style="display: none;">
                                            <div class="quadrant-name">Critical Gaps</div>
                                            <div class="quadrant-count" id="countQ4">0</div>
                                        </div>
                                    </div>
                                    
                                    <div class="recommendations" id="recommendationsSection" style="display: none;">
                                        <strong>Top Recommendations:</strong>
                                        <ul id="recommendationsList">
                                        </ul>
                                    </div>
                                    
                                    <a id="sufficiencyReportLink" href="#" target="_blank" class="btn btn-primary btn-full-report">
                                        üîç View Interactive Matrix
                                    </a>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadBtn">
                        üì• Download PDF
                    </button>
                    <button type="button" class="btn btn-warning" id="retryBtn">
                        üîÑ Retry Job
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Viewer Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        üìä Analysis Results - <span id="resultsJobId"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Sidebar: File browser -->
                        <div class="col-md-3">
                            <h6>Output Files</h6>
                            <div class="list-group" id="resultsFileList" style="max-height: 600px; overflow-y: auto;">
                                <div class="text-center text-muted p-3">
                                    Loading...
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="downloadAllResults()">
                                    üì¶ Download All (ZIP)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Main area: File viewer -->
                        <div class="col-md-9">
                            <div id="resultsViewer">
                                <div class="text-center text-muted p-5">
                                    <h5>Select a file to view</h5>
                                    <p>Choose a file from the list on the left</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Prompt Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        ‚è∏Ô∏è Job Paused - Input Required
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Job ID:</strong> <span id="promptJobId"></span>
                    </div>
                    
                    <h6 id="promptMessage"></h6>
                    
                    <!-- Prompt content (varies by type) -->
                    <div id="promptContent"></div>
                    
                    <!-- Timeout warning -->
                    <div class="alert alert-warning mt-3">
                        ‚è∞ Please respond within <span id="promptTimeout">5:00</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelPrompt()">
                        Cancel Job
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitPromptResponse()">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Warning Modal -->
    <div class="modal fade" id="duplicateWarningModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">‚ö†Ô∏è Duplicate Papers Detected</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-warning">
                        <strong><span id="duplicate-count">0</span> of <span id="total-count">0</span> papers already exist</strong> in your database.
                    </p>
                    
                    <h6>Duplicates Found:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Paper Title</th>
                                    <th>Match Type</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-list">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-3">New Papers (<span id="new-count">0</span>):</h6>
                    <ul id="new-papers-list" class="list-group">
                        <!-- Populated dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel Upload</button>
                    <button type="button" class="btn btn-primary" onclick="handleDuplicates('skip_duplicates')">
                        Skip Duplicates (Upload <span id="new-count-btn">0</span> New)
                    </button>
                    <button type="button" class="btn btn-danger" onclick="handleDuplicates('overwrite_all')">
                        Overwrite All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws/jobs`;
        
        // State
        let jobs = [];
        let ws = null;
        let apiKey = 'dev-key-change-in-production';
        let currentJobId = null;
        
        // WebSocket connection
        function connectWebSocket() {
            const wsStatus = document.getElementById('wsStatus');
            wsStatus.textContent = 'Connecting...';
            wsStatus.className = 'badge bg-warning';
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                wsStatus.textContent = 'Connected';
                wsStatus.className = 'badge bg-success';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                if (data.type === 'initial_state') {
                    jobs = data.jobs || [];
                    updateJobsTable();
                    updateMetrics();
                } else if (data.type === 'job_created' || data.type === 'job_update' || data.type === 'job_retry') {
                    updateJob(data.job);
                } else if (data.type === 'prompt_request') {
                    showPrompt(data);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                wsStatus.textContent = 'Disconnected';
                wsStatus.className = 'badge bg-danger';
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Progress WebSocket for job-specific real-time updates
        let progressWebSocket = null;
        let autoScroll = true;
        
        function connectProgressWebSocket(jobId) {
            // Close existing connection
            if (progressWebSocket) {
                progressWebSocket.close();
            }
            
            // Connect to job-specific progress stream
            const wsUrl = `ws://${window.location.host}/ws/jobs/${jobId}/progress`;
            progressWebSocket = new WebSocket(wsUrl);
            
            progressWebSocket.onopen = () => {
                console.log('Progress WebSocket connected');
                document.getElementById('progressContainer').style.display = 'block';
            };
            
            progressWebSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'initial_status':
                        handleInitialStatus(data.job);
                        break;
                    case 'progress':
                        handleProgressEvent(data.event);
                        break;
                    case 'logs':
                        handleLogLines(data.lines);
                        break;
                    case 'job_complete':
                        handleJobComplete(data.status);
                        break;
                }
            };
            
            progressWebSocket.onerror = (error) => {
                console.error('Progress WebSocket error:', error);
            };
            
            progressWebSocket.onclose = () => {
                console.log('Progress WebSocket disconnected');
            };
        }
        
        function handleInitialStatus(job) {
            console.log('Initial job status:', job);
        }
        
        function handleProgressEvent(event) {
            // Update progress bar
            if (event.percentage !== null && event.percentage !== undefined) {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = document.getElementById('progressPercentage');
                
                progressBar.style.width = event.percentage + '%';
                progressPercentage.textContent = event.percentage.toFixed(1) + '%';
            }
            
            // Update ETA display
            if (event.metadata && event.metadata.eta_seconds) {
                const etaElement = document.getElementById('etaDisplay');
                if (etaElement) {
                    const minutes = Math.floor(event.metadata.eta_seconds / 60);
                    const seconds = Math.floor(event.metadata.eta_seconds % 60);
                    etaElement.textContent = `ETA: ${minutes}m ${seconds}s`;
                }
            }
            
            // Update stage indicator
            const stageItem = document.querySelector(`[data-stage="${event.stage}"]`);
            if (stageItem) {
                const badge = stageItem.querySelector('.badge');
                const iterationCounter = stageItem.querySelector('.iteration-counter');
                
                // Remove all status classes
                stageItem.classList.remove('active', 'complete', 'error');
                
                switch (event.phase) {
                    case 'starting':
                    case 'running':
                        stageItem.classList.add('active');
                        badge.className = 'badge bg-primary';
                        badge.textContent = '‚è≥';
                        break;
                    case 'complete':
                        stageItem.classList.add('complete');
                        badge.className = 'badge bg-success';
                        badge.textContent = '‚úÖ';
                        break;
                    case 'error':
                        stageItem.classList.add('error');
                        badge.className = 'badge bg-danger';
                        badge.textContent = '‚ùå';
                        break;
                }
                
                // Show iteration counter if present
                if (event.metadata && event.metadata.iteration) {
                    iterationCounter.textContent = `(Iteration ${event.metadata.iteration})`;
                    iterationCounter.style.display = 'inline';
                }
            }
            
            // Add log line for event
            appendLogLine(`[${event.stage}] ${event.message}`, getLogClass(event.phase));
        }
        
        function handleLogLines(lines) {
            lines.forEach(line => {
                appendLogLine(line.trim());
            });
        }
        
        function appendLogLine(text, cssClass = '') {
            const logViewer = document.getElementById('liveLogViewer');
            
            // Remove "waiting" message if present
            if (logViewer.querySelector('.text-muted')) {
                logViewer.innerHTML = '';
            }
            
            const logLine = document.createElement('div');
            logLine.className = 'log-line ' + cssClass;
            logLine.textContent = text;
            
            logViewer.appendChild(logLine);
            
            // Auto-scroll if enabled
            if (autoScroll) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        }
        
        function getLogClass(phase) {
            switch (phase) {
                case 'error':
                    return 'error';
                case 'complete':
                    return 'success';
                case 'running':
                    return '';
                default:
                    return '';
            }
        }
        
        function clearLogs() {
            document.getElementById('liveLogViewer').innerHTML = '';
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const icon = document.getElementById('autoScrollIcon');
            icon.textContent = autoScroll ? 'üîí' : 'üîì';
        }
        
        function handleJobComplete(status) {
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.remove('progress-bar-animated');
            
            if (status === 'completed') {
                progressBar.classList.add('bg-success');
                progressBar.style.width = '100%';
                document.getElementById('progressPercentage').textContent = '100%';
            } else {
                progressBar.classList.add('bg-danger');
            }
        }
        
        // Update or add job in state
        function updateJob(job) {
            const index = jobs.findIndex(j => j.id === job.id);
            if (index >= 0) {
                jobs[index] = job;
            } else {
                jobs.unshift(job);
            }
            updateJobsTable();
            updateMetrics();
        }
        
        // Update metrics display
        function updateMetrics() {
            const total = jobs.length;
            const completed = jobs.filter(j => j.status === 'completed').length;
            const running = jobs.filter(j => j.status === 'running').length;
            const failed = jobs.filter(j => j.status === 'failed').length;
            
            document.getElementById('totalJobs').textContent = total;
            document.getElementById('completedJobs').textContent = completed;
            document.getElementById('runningJobs').textContent = running;
            document.getElementById('failedJobs').textContent = failed;
        }
        
        // Format date/time
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        // Calculate duration
        function calculateDuration(startTime, endTime) {
            if (!startTime) return '-';
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / 60000);
            const diffSecs = Math.floor((diffMs % 60000) / 1000);
            return `${diffMins}m ${diffSecs}s`;
        }
        
        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'draft': 'bg-info',
                'queued': 'bg-secondary',
                'running': 'bg-primary',
                'completed': 'bg-success',
                'failed': 'bg-danger'
            };
            const className = badges[status] || 'bg-secondary';
            return `<span class="badge ${className} status-badge">${status.toUpperCase()}</span>`;
        }
        
        // Update jobs table
        function updateJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            
            if (jobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No jobs yet. Upload a PDF to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = jobs.map(job => `
                <tr class="job-row" onclick="showJobDetail('${job.id}')">
                    <td><code>${job.id.substring(0, 8)}</code></td>
                    <td>${job.filename}</td>
                    <td>${getStatusBadge(job.status)}</td>
                    <td>${formatDateTime(job.created_at)}</td>
                    <td>${calculateDuration(job.started_at || job.created_at, job.completed_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showJobDetail('${job.id}')">
                            View
                        </button>
                        ${job.status === 'completed' ? `
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); showJobResults('${job.id}')">
                                üìä Results
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        // Helper methods for enhanced outputs
        function getScoreClass(score) {
            if (score >= 60) return 'score-high';
            if (score >= 40) return 'score-medium';
            return 'score-low';
        }

        function getVerdictClass(verdict) {
            const verdictMap = {
                'STRONG': 'verdict-strong',
                'MODERATE': 'verdict-moderate',
                'WEAK': 'verdict-weak',
                'INSUFFICIENT': 'verdict-insufficient'
            };
            return verdictMap[verdict] || 'verdict-unknown';
        }

        function getBudgetClass(percent) {
            if (percent > 80) return 'budget-high';
            if (percent > 50) return 'budget-medium';
            return 'budget-low';
        }

        // Fetch enhanced outputs for a job
        async function fetchEnhancedOutputs(jobId, apiKey) {
            try {
                const [proofRes, costRes, sufficiencyRes] = await Promise.all([
                    fetch(`${API_BASE}/api/jobs/${jobId}/proof-scorecard`, {
                        headers: {'X-API-KEY': apiKey}
                    }),
                    fetch(`${API_BASE}/api/jobs/${jobId}/cost-summary`, {
                        headers: {'X-API-KEY': apiKey}
                    }),
                    fetch(`${API_BASE}/api/jobs/${jobId}/sufficiency-summary`, {
                        headers: {'X-API-KEY': apiKey}
                    })
                ]);
                
                let hasAnyOutput = false;
                
                // Process proof scorecard
                if (proofRes.ok) {
                    const proofData = await proofRes.json();
                    if (proofData.available) {
                        hasAnyOutput = true;
                        displayProofScorecard(proofData);
                    }
                }
                
                // Process cost summary
                if (costRes.ok) {
                    const costData = await costRes.json();
                    if (costData.available) {
                        hasAnyOutput = true;
                        displayCostSummary(costData);
                    }
                }
                
                // Process sufficiency summary
                if (sufficiencyRes.ok) {
                    const sufficiencyData = await sufficiencyRes.json();
                    if (sufficiencyData.available) {
                        hasAnyOutput = true;
                        displaySufficiencySummary(sufficiencyData);
                    }
                }
                
                // Show enhanced outputs section if any output is available
                if (hasAnyOutput) {
                    document.getElementById('enhancedOutputsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to fetch enhanced outputs:', error);
            }
        }

        function displayProofScorecard(data) {
            const card = document.getElementById('proofScorecardCard');
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const verdictBadge = document.getElementById('verdictBadge');
            const headline = document.getElementById('scoreHeadline');
            const reportLink = document.getElementById('proofReportLink');
            
            // Update score
            scoreValue.textContent = data.overall_score + '%';
            scoreCircle.className = 'score-circle ' + getScoreClass(data.overall_score);
            
            // Update verdict
            verdictBadge.textContent = data.verdict;
            verdictBadge.className = 'verdict-badge ' + getVerdictClass(data.verdict);
            
            // Update headline
            headline.textContent = data.headline;
            
            // Update next steps
            if (data.next_steps && data.next_steps.length > 0) {
                const nextStepsList = document.getElementById('nextStepsList');
                nextStepsList.innerHTML = data.next_steps.slice(0, 3).map(step => 
                    `<li>${step}</li>`
                ).join('');
                document.getElementById('nextStepsSection').style.display = 'block';
            }
            
            // Update report link
            reportLink.href = data.html_path;
            
            card.style.display = 'block';
        }

        function displayCostSummary(data) {
            const card = document.getElementById('costSummaryCard');
            
            // Update costs
            document.getElementById('totalCost').textContent = '$' + data.total_cost.toFixed(2);
            document.getElementById('perPaperCost').textContent = '$' + data.per_paper_cost.toFixed(2);
            
            // Update budget bar
            const budgetBar = document.getElementById('budgetBar');
            const budgetPercent = document.getElementById('budgetPercent');
            budgetBar.style.width = data.budget_percent + '%';
            budgetBar.className = 'progress-bar ' + getBudgetClass(data.budget_percent);
            budgetPercent.textContent = data.budget_percent.toFixed(1) + '%';
            
            // Show cache savings if > 0
            if (data.cache_savings > 0) {
                document.getElementById('cacheSavings').textContent = '-$' + data.cache_savings.toFixed(2);
                document.getElementById('cacheSavingsRow').style.display = 'flex';
            }
            
            // Update report link
            document.getElementById('costReportLink').href = data.html_path;
            
            card.style.display = 'block';
        }

        function displaySufficiencySummary(data) {
            const card = document.getElementById('sufficiencyCard');
            
            // Update quadrants
            const quadrantMap = {
                'Q1-Strong-Foundation': ['quadrantQ1', 'countQ1'],
                'Q2-Promising-Seeds': ['quadrantQ2', 'countQ2'],
                'Q3-Hollow-Coverage': ['quadrantQ3', 'countQ3'],
                'Q4-Critical-Gaps': ['quadrantQ4', 'countQ4']
            };
            
            for (const [quadrant, [quadrantId, countId]] of Object.entries(quadrantMap)) {
                if (data.quadrants[quadrant] !== undefined) {
                    document.getElementById(countId).textContent = data.quadrants[quadrant];
                    document.getElementById(quadrantId).style.display = 'block';
                }
            }
            
            // Update recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                const recList = document.getElementById('recommendationsList');
                recList.innerHTML = data.recommendations.slice(0, 2).map(rec => 
                    `<li>${rec}</li>`
                ).join('');
                document.getElementById('recommendationsSection').style.display = 'block';
            }
            
            // Update report link
            document.getElementById('sufficiencyReportLink').href = data.html_path;
            
            card.style.display = 'block';
        }
        
        // Show job detail modal
        async function showJobDetail(jobId) {
            currentJobId = jobId;
            
            // Get current API key from input
            const currentApiKey = document.getElementById('apiKeyInput').value;
            
            try {
                // Fetch job details
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                    headers: {
                        'X-API-KEY': currentApiKey
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch job details');
                
                const job = await response.json();
                
                // Update modal content
                document.getElementById('detailJobId').textContent = job.id;
                document.getElementById('detailStatus').innerHTML = getStatusBadge(job.status);
                document.getElementById('detailFilename').textContent = job.filename;
                document.getElementById('detailCreated').textContent = formatDateTime(job.created_at);
                
                // Show error if exists
                const errorSection = document.getElementById('errorSection');
                if (job.error) {
                    document.getElementById('detailError').textContent = job.error;
                    errorSection.style.display = 'block';
                } else {
                    errorSection.style.display = 'none';
                }
                
                // Show progress if exists
                const progressSection = document.getElementById('progressSection');
                if (job.progress && Object.keys(job.progress).length > 0) {
                    document.getElementById('detailProgress').textContent = JSON.stringify(job.progress, null, 2);
                    progressSection.style.display = 'block';
                } else {
                    progressSection.style.display = 'none';
                }
                
                // Fetch logs
                const logsResponse = await fetch(`${API_BASE}/api/logs/${jobId}?tail=100`, {
                    headers: {
                        'X-API-KEY': currentApiKey
                    }
                });
                
                if (logsResponse.ok) {
                    const logsData = await logsResponse.json();
                    document.getElementById('detailLogs').textContent = logsData.logs || 'No logs available';
                } else {
                    document.getElementById('detailLogs').textContent = 'Failed to load logs';
                }
                
                // Hide all enhanced output cards initially
                document.getElementById('enhancedOutputsSection').style.display = 'none';
                document.getElementById('proofScorecardCard').style.display = 'none';
                document.getElementById('costSummaryCard').style.display = 'none';
                document.getElementById('sufficiencyCard').style.display = 'none';
                document.getElementById('nextStepsSection').style.display = 'none';
                document.getElementById('cacheSavingsRow').style.display = 'none';
                document.getElementById('recommendationsSection').style.display = 'none';
                
                // Fetch enhanced outputs if job is completed
                if (job.status === 'completed') {
                    await fetchEnhancedOutputs(jobId, currentApiKey);
                }
                
                // Connect to progress stream if job is running or queued
                if (job.status === 'running' || job.status === 'queued') {
                    connectProgressWebSocket(jobId);
                } else {
                    // Hide progress container for completed/failed jobs
                    document.getElementById('progressContainer').style.display = 'none';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error fetching job details:', error);
                alert('Failed to load job details: ' + error.message);
            }
        }
        
        // Upload form handler - Batch upload with configuration
        document.getElementById('batchUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('batchFileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one PDF file');
                return;
            }
            
            // Update API key from input
            apiKey = document.getElementById('apiKeyInput').value;
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`${API_BASE}/api/upload/batch`, {
                    method: 'POST',
                    headers: { 'X-API-KEY': apiKey },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const result = await response.json();
                
                // Check if duplicates were found
                if (result.status === 'duplicates_found') {
                    showDuplicateWarning(result);
                } else {
                    // Show configuration modal
                    currentJobId = result.job_id;
                    document.getElementById('configJobId').textContent = result.job_id;
                    document.getElementById('configFileCount').textContent = result.file_count;
                    
                    const modal = new bootstrap.Modal(document.getElementById('configModal'));
                    modal.show();
                }
                
                // Reset form
                fileInput.value = '';
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });
        
        // Store upload data globally for duplicate confirmation
        let uploadData = null;
        
        // Show duplicate warning modal
        function showDuplicateWarning(data) {
            uploadData = data;
            
            // Update counts
            document.getElementById('duplicate-count').textContent = data.duplicates.length;
            document.getElementById('total-count').textContent = data.duplicates.length + data.new.length;
            document.getElementById('new-count').textContent = data.new.length;
            document.getElementById('new-count-btn').textContent = data.new.length;
            
            // Populate duplicate list
            const tbody = document.getElementById('duplicate-list');
            tbody.innerHTML = '';
            for (let dup of data.duplicates) {
                const matchInfo = dup.match_info || {};
                const method = matchInfo.method || 'unknown';
                const confidence = matchInfo.confidence || 0;
                
                let methodBadge = '';
                switch(method) {
                    case 'hash':
                        methodBadge = '<span class="badge bg-danger">Exact File Match</span>';
                        break;
                    case 'exact_title':
                        methodBadge = '<span class="badge bg-warning">Title Match</span>';
                        break;
                    case 'fuzzy_title':
                        methodBadge = '<span class="badge bg-info">Similar Title</span>';
                        break;
                    default:
                        methodBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                const row = `
                    <tr>
                        <td>${dup.title || dup.original_name}</td>
                        <td>${methodBadge}</td>
                        <td>${(confidence * 100).toFixed(1)}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
            
            // Populate new papers list
            const newList = document.getElementById('new-papers-list');
            newList.innerHTML = '';
            for (let paper of data.new) {
                const item = `<li class="list-group-item">${paper.title || paper.original_name}</li>`;
                newList.innerHTML += item;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('duplicateWarningModal'));
            modal.show();
        }
        
        // Handle duplicate confirmation
        async function handleDuplicates(action) {
            if (!uploadData) {
                alert('No upload data available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/upload/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        action: action,
                        job_id: uploadData.job_id
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Confirmation failed');
                }
                
                const result = await response.json();
                
                // Hide duplicate modal
                const duplicateModal = bootstrap.Modal.getInstance(document.getElementById('duplicateWarningModal'));
                duplicateModal.hide();
                
                // Show success message
                alert(result.message);
                
                // Show configuration modal if there are files to configure
                if (result.uploaded > 0) {
                    currentJobId = uploadData.job_id;
                    document.getElementById('configJobId').textContent = uploadData.job_id;
                    document.getElementById('configFileCount').textContent = result.uploaded;
                    
                    const configModal = new bootstrap.Modal(document.getElementById('configModal'));
                    configModal.show();
                } else {
                    // No files to configure, refresh job list
                    await loadJobs();
                }
                
                // Clear upload data
                uploadData = null;
                
            } catch (error) {
                alert('Failed to confirm upload: ' + error.message);
            }
        }
        
        // Load pillar definitions and populate checkboxes
        async function loadPillarDefinitions() {
            try {
                const response = await fetch('/static/pillar_definitions.json');
                const definitions = await response.json();
                
                const container = document.getElementById('pillarCheckboxes');
                container.innerHTML = '';
                
                // Filter out metadata sections
                const metadata = ['Framework_Overview', 'Cross_Cutting_Requirements', 'Success_Criteria'];
                
                for (const [key, value] of Object.entries(definitions)) {
                    if (metadata.includes(key)) continue;
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'form-check';
                    checkbox.innerHTML = `
                        <input 
                            class="form-check-input pillar-checkbox-individual" 
                            type="checkbox" 
                            value="${key}" 
                            id="pillar_${key.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <label class="form-check-label" for="pillar_${key.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${key.replace(/_/g, ' ')}
                        </label>
                    `;
                    container.appendChild(checkbox);
                }
            } catch (error) {
                console.error('Failed to load pillar definitions:', error);
            }
        }
        
        // Toggle all pillars
        function toggleAllPillars(checkbox) {
            const individual = document.querySelectorAll('.pillar-checkbox-individual');
            individual.forEach(cb => {
                cb.checked = checkbox.checked;
                cb.disabled = checkbox.checked;
            });
        }
        
        // Save configuration and start job
        async function saveConfigAndStart() {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            // Collect selected pillars
            let pillar_selections = [];
            if (document.getElementById('pillar_all').checked) {
                pillar_selections = ['ALL'];
            } else {
                document.querySelectorAll('.pillar-checkbox-individual:checked').forEach(cb => {
                    pillar_selections.push(cb.value);
                });
            }
            
            if (pillar_selections.length === 0) {
                alert('Please select at least one pillar');
                return;
            }
            
            // Get run mode
            const run_mode = document.querySelector('input[name="runMode"]:checked').value;
            
            // Get advanced options
            const convergence_threshold = parseFloat(
                document.getElementById('convergenceThreshold').value
            );
            
            const config = {
                pillar_selections,
                run_mode,
                convergence_threshold
            };
            
            try {
                // Save configuration
                const configResponse = await fetch(`${API_BASE}/api/jobs/${currentJobId}/configure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify(config)
                });
                
                if (!configResponse.ok) throw new Error('Configuration failed');
                
                // Start job execution
                const startResponse = await fetch(`${API_BASE}/api/jobs/${currentJobId}/start`, {
                    method: 'POST',
                    headers: { 'X-API-KEY': apiKey }
                });
                
                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    throw new Error(error.detail || 'Failed to start job');
                }
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                
                alert(`Job ${currentJobId} started successfully!`);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Download button handler
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            const currentApiKey = document.getElementById('apiKeyInput').value;
            window.open(`${API_BASE}/api/download/${currentJobId}?X-API-KEY=${currentApiKey}`, '_blank');
        });
        
        // Retry button handler
        document.getElementById('retryBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            const currentApiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${currentJobId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': currentApiKey
                    },
                    body: JSON.stringify({ force: false })
                });
                
                if (!response.ok) throw new Error('Retry request failed');
                
                const result = await response.json();
                alert('Retry requested successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('jobDetailModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Retry error:', error);
                alert('Retry failed: ' + error.message);
            }
        });
        
        // Results Viewer Functions
        async function showJobResults(jobId) {
            // Set modal title
            document.getElementById('resultsJobId').textContent = jobId;
            currentJobId = jobId;
            
            // Fetch results list
            const response = await fetch(`${API_BASE}/api/jobs/${jobId}/results`, {
                headers: { 'X-API-KEY': apiKey }
            });
            
            if (!response.ok) {
                alert('Failed to load results');
                return;
            }
            
            const data = await response.json();
            
            // Render file list grouped by category
            renderFileList(data.outputs);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
            modal.show();
        }
        
        function renderFileList(outputs) {
            const fileList = document.getElementById('resultsFileList');
            fileList.innerHTML = '';
            
            // Group by category
            const grouped = {};
            outputs.forEach(file => {
                if (!grouped[file.category]) {
                    grouped[file.category] = [];
                }
                grouped[file.category].push(file);
            });
            
            // Render each category
            const categoryTitles = {
                'pillar_waterfalls': 'üìä Pillar Waterfalls',
                'visualizations': 'üìà Visualizations',
                'reports': 'üìÑ Reports',
                'data': 'üíæ Data Files',
                'other': 'üì¶ Other'
            };
            
            for (const [category, files] of Object.entries(grouped)) {
                // Category header
                const header = document.createElement('div');
                header.className = 'list-group-item bg-light fw-bold';
                header.textContent = categoryTitles[category] || category;
                fileList.appendChild(header);
                
                // Files in category
                files.forEach(file => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-truncate" style="font-size: 0.85rem;">${file.filename}</span>
                            <span class="badge bg-secondary">${formatFileSize(file.size)}</span>
                        </div>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        viewFile(file);
                    };
                    fileList.appendChild(item);
                });
            }
        }
        
        async function viewFile(file) {
            const viewer = document.getElementById('resultsViewer');
            
            // Show loading
            viewer.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            
            const fileUrl = `${API_BASE}/api/jobs/${currentJobId}/results/${file.path}`;
            
            try {
                if (file.mime_type === 'text/html' || file.filename.endsWith('.html')) {
                    // Render HTML in iframe
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <iframe 
                            src="${fileUrl}" 
                            style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 5px;">
                        </iframe>
                    `;
                } else if (file.mime_type === 'application/json' || file.filename.endsWith('.json')) {
                    // Fetch and pretty-print JSON
                    const response = await fetch(fileUrl, {
                        headers: { 'X-API-KEY': apiKey }
                    });
                    const jsonData = await response.json();
                    
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <pre class="bg-dark text-light p-3" style="max-height: 600px; overflow-y: auto; border-radius: 5px;"><code>${JSON.stringify(jsonData, null, 2)}</code></pre>
                    `;
                } else if (file.mime_type?.startsWith('text/') || file.filename.endsWith('.md')) {
                    // Fetch and display text/markdown
                    const response = await fetch(fileUrl, {
                        headers: { 'X-API-KEY': apiKey }
                    });
                    const textData = await response.text();
                    
                    viewer.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${file.filename}</h6>
                            <a href="${fileUrl}" class="btn btn-sm btn-outline-primary" download>
                                üíæ Download
                            </a>
                        </div>
                        <pre class="bg-light p-3" style="max-height: 600px; overflow-y: auto; border-radius: 5px;"><code>${escapeHtml(textData)}</code></pre>
                    `;
                } else {
                    // Download-only for binary files
                    viewer.innerHTML = `
                        <div class="text-center p-5">
                            <h5>${file.filename}</h5>
                            <p class="text-muted">Preview not available for this file type</p>
                            <a href="${fileUrl}" class="btn btn-primary" download>
                                üíæ Download File
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                viewer.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load file: ${error.message}
                    </div>
                `;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function downloadAllResults() {
            window.open(`${API_BASE}/api/jobs/${currentJobId}/results/download/all`, '_blank');
        }
        
        // === INTERACTIVE PROMPTS ===
        let currentPromptId = null;
        let currentPromptType = null;
        let promptTimeoutInterval = null;
        
        function showPrompt(promptData) {
            currentPromptId = promptData.prompt_id;
            currentPromptType = promptData.prompt_type;
            
            // Set job ID
            document.getElementById('promptJobId').textContent = promptData.job_id;
            
            // Set message
            document.getElementById('promptMessage').textContent = promptData.prompt_data.message;
            
            // Render prompt content based on type
            const content = document.getElementById('promptContent');
            
            switch (promptData.prompt_type) {
                case 'pillar_selection':
                    content.innerHTML = renderPillarSelectionPrompt(promptData.prompt_data);
                    break;
                case 'run_mode':
                    content.innerHTML = renderRunModePrompt(promptData.prompt_data);
                    break;
                case 'continue':
                    content.innerHTML = renderContinuePrompt(promptData.prompt_data);
                    break;
                default:
                    content.innerHTML = '<p>Unknown prompt type</p>';
            }
            
            // Start timeout countdown
            startTimeoutCountdown(300); // 5 minutes
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('promptModal'));
            modal.show();
        }
        
        function renderPillarSelectionPrompt(promptData) {
            const pillars = promptData.options || [];
            
            let html = '<div class="mb-3">';
            
            // Helper buttons and count badge
            html += `
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPillars()">
                            ‚úì Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllPillars()">
                            ‚úï Clear All
                        </button>
                    </div>
                    <div>
                        <span id="pillar-count" class="badge bg-secondary">0 selected</span>
                    </div>
                </div>
                <hr>
            `;
            
            // Special options (mutually exclusive with individual pillars)
            if (promptData.allow_all) {
                html += `
                    <div class="form-check">
                        <input class="form-check-input special-option" type="checkbox" value="ALL" id="choice_all" onchange="handleSpecialOption('ALL')">
                        <label class="form-check-label fw-bold" for="choice_all">
                            ALL - Analyze all pillars (single pass)
                        </label>
                    </div>
                `;
            }
            
            if (promptData.allow_deep) {
                html += `
                    <div class="form-check">
                        <input class="form-check-input special-option" type="checkbox" value="DEEP" id="choice_deep" onchange="handleSpecialOption('DEEP')">
                        <label class="form-check-label fw-bold" for="choice_deep">
                            DEEP - Run iterative deep-review loop
                        </label>
                    </div>
                `;
            }
            
            if (promptData.allow_none) {
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input special-option" type="checkbox" value="NONE" id="choice_none" onchange="handleSpecialOption('NONE')">
                        <label class="form-check-label fw-bold" for="choice_none">
                            NONE - Cancel analysis
                        </label>
                    </div>
                `;
            }
            
            html += '<hr>';
            
            // Individual pillars (checkbox multi-select)
            html += '<div id="individual-pillars">';
            pillars.forEach((pillar, index) => {
                const pillarName = pillar.split(':')[0];
                html += `
                    <div class="form-check">
                        <input class="form-check-input pillar-checkbox" type="checkbox" value="${pillar}" id="choice_${index}" onchange="updatePillarCount()">
                        <label class="form-check-label" for="choice_${index}">
                            ${index + 1}. ${pillarName}
                        </label>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        function renderRunModePrompt(promptData) {
            return `
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="ONCE" id="mode_once" checked>
                        <label class="form-check-label" for="mode_once">
                            <strong>ONCE</strong> - Single pass analysis
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="DEEP_LOOP" id="mode_deep_loop">
                        <label class="form-check-label" for="mode_deep_loop">
                            <strong>DEEP_LOOP</strong> - Iterative analysis until convergence
                        </label>
                    </div>
                </div>
            `;
        }
        
        function renderContinuePrompt(promptData) {
            return `
                <p>${promptData.details || 'Continue?'}</p>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="yes" id="continue_yes" checked>
                        <label class="form-check-label" for="continue_yes">
                            Yes, continue
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="promptChoice" value="no" id="continue_no">
                        <label class="form-check-label" for="continue_no">
                            No, stop here
                        </label>
                    </div>
                </div>
            `;
        }
        
        function selectAllPillars() {
            // Uncheck special options
            document.querySelectorAll('.special-option').forEach(cb => cb.checked = false);
            
            // Check all individual pillars
            document.querySelectorAll('.pillar-checkbox').forEach(cb => cb.checked = true);
            updatePillarCount();
        }
        
        function clearAllPillars() {
            // Uncheck everything
            document.querySelectorAll('.special-option, .pillar-checkbox').forEach(cb => cb.checked = false);
            updatePillarCount();
        }
        
        function handleSpecialOption(option) {
            const checkbox = document.getElementById(`choice_${option.toLowerCase()}`);
            
            if (checkbox && checkbox.checked) {
                // Uncheck all other options (special and individual)
                document.querySelectorAll('.special-option, .pillar-checkbox').forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                    }
                });
            }
            
            updatePillarCount();
        }
        
        function updatePillarCount() {
            // Count selected individual pillars
            const selectedPillars = document.querySelectorAll('.pillar-checkbox:checked').length;
            
            // Check if special option selected
            const specialSelected = document.querySelector('.special-option:checked');
            const countBadge = document.getElementById('pillar-count');
            
            if (!countBadge) return; // Not in pillar selection prompt
            
            if (specialSelected) {
                countBadge.textContent = specialSelected.value;
                countBadge.className = 'badge bg-primary';
            } else if (selectedPillars > 0) {
                countBadge.textContent = `${selectedPillars} selected`;
                countBadge.className = 'badge bg-info';
            } else {
                countBadge.textContent = '0 selected';
                countBadge.className = 'badge bg-secondary';
            }
        }
        
        function getSelectedPillars() {
            // Check for special options first
            const specialOption = document.querySelector('.special-option:checked');
            if (specialOption) {
                return specialOption.value;  // Return "ALL", "DEEP", or "NONE"
            }
            
            // Otherwise, return array of selected individual pillars
            const selected = [];
            document.querySelectorAll('.pillar-checkbox:checked').forEach(cb => {
                selected.push(cb.value);
            });
            
            // Validation
            if (selected.length === 0) {
                return null;  // Indicates validation failure
            }
            
            return selected;  // Returns array like ["P1: Pillar 1", "P3: Pillar 3"]
        }
        
        function startTimeoutCountdown(seconds) {
            const display = document.getElementById('promptTimeout');
            let remaining = seconds;
            
            if (promptTimeoutInterval) {
                clearInterval(promptTimeoutInterval);
            }
            
            promptTimeoutInterval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(promptTimeoutInterval);
                    alert('Prompt timed out. Job will be cancelled.');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                    if (modal) modal.hide();
                }
                
                remaining--;
            }, 1000);
        }
        
        async function submitPromptResponse() {
            let response;
            
            // Handle different prompt types
            if (currentPromptType === 'pillar_selection') {
                response = getSelectedPillars();
                if (response === null) {
                    alert('Please select at least one pillar or choose a special option (ALL, DEEP, NONE)');
                    return;
                }
            } else {
                // Other prompt types use radio buttons
                const selected = document.querySelector('input[name="promptChoice"]:checked');
                
                if (!selected) {
                    alert('Please select an option');
                    return;
                }
                
                response = selected.value;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const result = await fetch(`${API_BASE}/api/prompts/${currentPromptId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ response })
                });
                
                if (!result.ok) {
                    const errorData = await result.json();
                    throw new Error(errorData.detail || 'Failed to submit response');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                if (modal) modal.hide();
                
                // Clear timeout
                if (promptTimeoutInterval) {
                    clearInterval(promptTimeoutInterval);
                }
                
                // Show notification
                console.log('Response submitted. Job will continue.');
                
            } catch (error) {
                alert('Failed to submit response: ' + error.message);
            }
        }
        
        function cancelPrompt() {
            // Submit "NONE" as cancellation response
            const noneRadio = document.querySelector('input[name="promptChoice"][value="NONE"]');
            if (noneRadio) {
                noneRadio.checked = true;
                submitPromptResponse();
            } else {
                // If no NONE option, just close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                if (modal) modal.hide();
                if (promptTimeoutInterval) {
                    clearInterval(promptTimeoutInterval);
                }
            }
        }
        
        // Initialize
        connectWebSocket();
        loadPillarDefinitions();
    </script>
</body>
</html>
