<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literature Review Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            padding-top: 20px;
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.35rem 0.65rem;
        }
        .job-row {
            cursor: pointer;
        }
        .job-row:hover {
            background-color: #f8f9fa;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #uploadProgress {
            display: none;
        }
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status">
        <span class="badge bg-secondary" id="wsStatus">Connecting...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-4">ðŸ“š Literature Review Dashboard</h1>
                <p class="lead">Monitor and manage pipeline jobs</p>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Total Jobs</h5>
                        <h2 class="display-4" id="totalJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">Completed</h5>
                        <h2 class="display-4" id="completedJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Running</h5>
                        <h2 class="display-4" id="runningJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title text-danger">Failed</h5>
                        <h2 class="display-4" id="failedJobs">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ðŸ“¤ Upload New PDF</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Select PDF file</label>
                                <input class="form-control" type="file" id="fileInput" accept=".pdf" required>
                            </div>
                            <div class="mb-3">
                                <label for="apiKeyInput" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="apiKeyInput" 
                                       placeholder="Enter API key" value="dev-key-change-in-production">
                            </div>
                            <button type="submit" class="btn btn-primary">Upload & Queue Job</button>
                        </form>
                        <div class="progress mt-3" id="uploadProgress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ðŸ“‹ Jobs</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No jobs yet. Upload a PDF to get started.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal fade" id="jobDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Job ID:</strong>
                            <p id="detailJobId" class="font-monospace"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            <p id="detailStatus"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Filename:</strong>
                            <p id="detailFilename"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong>
                            <p id="detailCreated"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="errorSection" style="display: none;">
                        <strong>Error:</strong>
                        <div class="alert alert-danger" id="detailError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Logs:</strong>
                        <div class="log-viewer" id="detailLogs">
                            Loading logs...
                        </div>
                    </div>
                    
                    <div class="mb-3" id="progressSection" style="display: none;">
                        <strong>Progress:</strong>
                        <div id="detailProgress"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadBtn">
                        ðŸ“¥ Download PDF
                    </button>
                    <button type="button" class="btn btn-warning" id="retryBtn">
                        ðŸ”„ Retry Job
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws/jobs`;
        
        // State
        let jobs = [];
        let ws = null;
        let apiKey = 'dev-key-change-in-production';
        let currentJobId = null;
        
        // WebSocket connection
        function connectWebSocket() {
            const wsStatus = document.getElementById('wsStatus');
            wsStatus.textContent = 'Connecting...';
            wsStatus.className = 'badge bg-warning';
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                wsStatus.textContent = 'Connected';
                wsStatus.className = 'badge bg-success';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                if (data.type === 'initial_state') {
                    jobs = data.jobs || [];
                    updateJobsTable();
                    updateMetrics();
                } else if (data.type === 'job_created' || data.type === 'job_update' || data.type === 'job_retry') {
                    updateJob(data.job);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                wsStatus.textContent = 'Disconnected';
                wsStatus.className = 'badge bg-danger';
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Update or add job in state
        function updateJob(job) {
            const index = jobs.findIndex(j => j.id === job.id);
            if (index >= 0) {
                jobs[index] = job;
            } else {
                jobs.unshift(job);
            }
            updateJobsTable();
            updateMetrics();
        }
        
        // Update metrics display
        function updateMetrics() {
            const total = jobs.length;
            const completed = jobs.filter(j => j.status === 'completed').length;
            const running = jobs.filter(j => j.status === 'running').length;
            const failed = jobs.filter(j => j.status === 'failed').length;
            
            document.getElementById('totalJobs').textContent = total;
            document.getElementById('completedJobs').textContent = completed;
            document.getElementById('runningJobs').textContent = running;
            document.getElementById('failedJobs').textContent = failed;
        }
        
        // Format date/time
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        // Calculate duration
        function calculateDuration(startTime, endTime) {
            if (!startTime) return '-';
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / 60000);
            const diffSecs = Math.floor((diffMs % 60000) / 1000);
            return `${diffMins}m ${diffSecs}s`;
        }
        
        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'queued': 'bg-secondary',
                'running': 'bg-primary',
                'completed': 'bg-success',
                'failed': 'bg-danger'
            };
            const className = badges[status] || 'bg-secondary';
            return `<span class="badge ${className} status-badge">${status.toUpperCase()}</span>`;
        }
        
        // Update jobs table
        function updateJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            
            if (jobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No jobs yet. Upload a PDF to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = jobs.map(job => `
                <tr class="job-row" onclick="showJobDetail('${job.id}')">
                    <td><code>${job.id.substring(0, 8)}</code></td>
                    <td>${job.filename}</td>
                    <td>${getStatusBadge(job.status)}</td>
                    <td>${formatDateTime(job.created_at)}</td>
                    <td>${calculateDuration(job.started_at || job.created_at, job.completed_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showJobDetail('${job.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Show job detail modal
        async function showJobDetail(jobId) {
            currentJobId = jobId;
            
            try {
                // Fetch job details
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                    headers: {
                        'X-API-KEY': apiKey
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch job details');
                
                const job = await response.json();
                
                // Update modal content
                document.getElementById('detailJobId').textContent = job.id;
                document.getElementById('detailStatus').innerHTML = getStatusBadge(job.status);
                document.getElementById('detailFilename').textContent = job.filename;
                document.getElementById('detailCreated').textContent = formatDateTime(job.created_at);
                
                // Show error if exists
                const errorSection = document.getElementById('errorSection');
                if (job.error) {
                    document.getElementById('detailError').textContent = job.error;
                    errorSection.style.display = 'block';
                } else {
                    errorSection.style.display = 'none';
                }
                
                // Show progress if exists
                const progressSection = document.getElementById('progressSection');
                if (job.progress && Object.keys(job.progress).length > 0) {
                    document.getElementById('detailProgress').textContent = JSON.stringify(job.progress, null, 2);
                    progressSection.style.display = 'block';
                } else {
                    progressSection.style.display = 'none';
                }
                
                // Fetch logs
                const logsResponse = await fetch(`${API_BASE}/api/logs/${jobId}?tail=100`, {
                    headers: {
                        'X-API-KEY': apiKey
                    }
                });
                
                if (logsResponse.ok) {
                    const logsData = await logsResponse.json();
                    document.getElementById('detailLogs').textContent = logsData.logs || 'No logs available';
                } else {
                    document.getElementById('detailLogs').textContent = 'Failed to load logs';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error fetching job details:', error);
                alert('Failed to load job details: ' + error.message);
            }
        }
        
        // Upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            // Update API key from input
            apiKey = document.getElementById('apiKeyInput').value;
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    headers: {
                        'X-API-KEY': apiKey
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const result = await response.json();
                
                // Reset form
                fileInput.value = '';
                
                // Show success
                alert(`File uploaded successfully! Job ID: ${result.job_id}`);
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });
        
        // Download button handler
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            window.open(`${API_BASE}/api/download/${currentJobId}?X-API-KEY=${apiKey}`, '_blank');
        });
        
        // Retry button handler
        document.getElementById('retryBtn').addEventListener('click', async () => {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs/${currentJobId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({ force: false })
                });
                
                if (!response.ok) throw new Error('Retry request failed');
                
                const result = await response.json();
                alert('Retry requested successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('jobDetailModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Retry error:', error);
                alert('Retry failed: ' + error.message);
            }
        });
        
        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
